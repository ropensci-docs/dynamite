<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>dynamite: An R Package for Dynamic Multivariate Panel Models • dynamite</title>
<!-- rOpenSci favicons --><link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="/apple-touch-icon.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="dynamite: An R Package for Dynamic Multivariate Panel Models">
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.css">
<script src="https://cdn.jsdelivr.net/gh/orestbida/cookieconsent@v3.0.0/dist/cookieconsent.umd.js" data-cfasync="false"></script><script src="https://ropensci.org/scripts/matomo.js"></script><noscript><p><img src="https://ropensci.matomo.cloud/matomo.php?idsite=1&amp;rec=1" style="border:0;" alt=""></p></noscript>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">
    <a href="https://ropensci.org" class="external-link"><img src="https://ropensci.org/img/icon_short_white.svg" id="hexlogo" alt="rOpenSci"></a>
    <a class="navbar-brand me-2" href="../index.html">dynamite</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Released version">1.5.4</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto"></ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="active nav-item"><a class="nav-link" href="../articles/dynamite.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/dynamite_custom.html">Model customization and non-MCMC estimation with dynamite</a></li>
    <li><a class="dropdown-item" href="../articles/dynamite_priors.html">Priors for dynamic multivariate panel models</a></li>
    <li><a class="dropdown-item" href="../articles/dynamite_simulation.html">Simulating data from a dynamic multivariate panel model</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/ropensci/dynamite/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>dynamite: An R Package for Dynamic Multivariate Panel Models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ropensci/dynamite/blob/master/vignettes/dynamite.Rmd" class="external-link"><code>vignettes/dynamite.Rmd</code></a></small>
      <div class="d-none name"><code>dynamite.Rmd</code></div>
    </div>

    
    
<style>
body {text-align: justify}
</style>
<p><strong>dynamite</strong> is an R package for Bayesian inference of intensive panel (time series) data comprising multiple measurements per multiple individuals measured in time. The package supports joint modeling of multiple response variables, time-varying and time-invariant effects, a wide range of discrete and continuous distributions, group-specific random effects, latent factors, and customization of prior distributions of the model parameters. Models in the package are defined via a user-friendly formula interface, and estimation of the posterior distribution of the model parameters takes advantage of state-of-the-art Markov chain Monte Carlo methods. The package enables efficient computation of both individual-level and aggregated predictions and offers a comprehensive suite of tools for visualization and model diagnostics. This vignette is a modification of <span class="citation">(<a href="#ref-dynamite">Tikka and Helske 2024a</a>)</span>.</p>
<div class="section level2" number="1">
<h2 id="sec:intro">
<span class="header-section-number">1</span> Introduction<a class="anchor" aria-label="anchor" href="#sec:intro"></a>
</h2>
<p>Panel data is common in various fields such as social sciences. These data consist of multiple individuals followed over several time points, and there are often many observations per individual at each time, for example, family status and income of each individual at each time point of interest. Such data can be analyzed in various ways, depending on the research questions and the characteristics of the data such as the number of individuals and time points, and the assumed distribution of the response variables. In social sciences, popular, somewhat overlapping modeling approaches include dynamic panel models, fixed effect models, dynamic structural equation models <span class="citation">(<a href="#ref-Asparouhov2018">Asparouhov, Hamaker, and Muthén 2018</a>)</span>, cross-lagged panel models (CLPM), and their various extensions such as CLPM with fixed or random effects <span class="citation">(<a href="#ref-arellano1991">Arellano and Bond 1991</a>; <a href="#ref-Allison2009">Allison 2009</a>; <a href="#ref-Bollen2010">Bollen and Brand 2010</a>; <a href="#ref-Allison2017">Allison, Williams, and Moral-Benito 2017</a>; <a href="#ref-Hamaker2015">Hamaker, Kuiper, and Grasman 2015</a>; <a href="#ref-Mulder2021">Mulder and Hamaker 2021</a>)</span> and general cross-lagged panel model <span class="citation">(<a href="#ref-Zyphur2020">Zyphur et al. 2020</a>)</span>.</p>
<p>There are several R <span class="citation">(<a href="#ref-R">R Core Team 2023</a>)</span> packages available from the Comprehensive R Archive Network (CRAN) focusing on the analysis of panel data. The <strong>plm</strong> package <span class="citation">(<a href="#ref-plm">Croissant and Millo 2008</a>)</span> provides various estimation methods and tests for linear panel data models, while the <strong>fixest</strong> package <span class="citation">(<a href="#ref-fixest">Bergé 2018</a>)</span> supports multiple fixed effects and different distributions of response variables. The <strong>panelr</strong> package <span class="citation">(<a href="#ref-panelr">Long 2020</a>)</span> contains tools for panel data manipulation and estimation methods for so-called “within-between” models that combine fixed effect and random effect models. This is done by using <strong>lme4</strong>, <strong>geepack</strong>, and <strong>brms</strong> packages as a backend <span class="citation">(<a href="#ref-lme4">Bates et al. 2015</a>; <a href="#ref-geepack">Halekoh, Højsgaard, and Yan 2006</a>; <a href="#ref-brms">Bürkner 2018</a>)</span>. The <strong>lavaan</strong> package <span class="citation">(<a href="#ref-lavaan">Rosseel 2012</a>)</span> provides methods for general structural equation modeling (SEM) and thus can be used to estimate various panel data models such as CLPMs with fixed or random intercepts. Similarly, it is also possible to use general multilevel modeling packages such as <strong>lme4</strong> and <strong>brms</strong> directly for panel data modeling. Of these, only <strong>lavaan</strong> and <strong>brms</strong> support joint modeling of multiple interdependent response variables, which is typically necessary for multi-step predictions and long-term causal effect estimation <span class="citation">(<a href="#ref-dmpm">Helske and Tikka 2024</a>)</span>.</p>
<p>In traditional panel data models such as the ones supported by the aforementioned packages, the number of time points considered is often assumed to be relatively small, say less than 10, while the number of individuals can be hundreds or thousands <span class="citation">(<a href="#ref-Wooldridge2010">Wooldridge 2010</a>)</span>. This is especially true for commonly used “wide format” SEM approaches that are unable to consider a large number of time points <span class="citation">(<a href="#ref-Asparouhov2018">Asparouhov, Hamaker, and Muthén 2018</a>)</span>. Perhaps due to the small number of time points, the effects of covariates are typically assumed to be time-invariant, although some extensions to time-varying effects have emerged <span class="citation">(e.g., <a href="#ref-Sun2009">Sun, Carroll, and Li 2009</a>; <a href="#ref-Asparouhov2018">Asparouhov, Hamaker, and Muthén 2018</a>; <a href="#ref-hayakawa2019">Hayakawa and Hou 2019</a>)</span>. On the other hand, when the number of time points is moderate or large, say hundreds or thousands (sometimes referred to as intensive longitudinal data), it can be reasonable to assume that the dynamics of the system change over time, for example in the form of time-varying effects.</p>
<p>Modeling time-varying effects in (generalized) linear models can be based on state-space models <span class="citation">(SSMs, <a href="#ref-harvey1982">Harvey and Phillips 1982</a>; <a href="#ref-durbin2012">Durbin and Koopman 2012</a>; <a href="#ref-helske2022">Helske 2022</a>)</span>, for which there are various R implementations such as <strong>walker</strong> <span class="citation">(<a href="#ref-helske2022">Helske 2022</a>)</span>, <strong>shrinkTVP</strong> <span class="citation">(<a href="#ref-knaus2021">Knaus et al. 2021</a>)</span>, and <strong>CausalImpact</strong> <span class="citation">(<a href="#ref-brodersen2014">Brodersen et al. 2014</a>)</span>. However, these implementations are restricted to a non-panel setting of a single individual and a single response variable. Other approaches include methods based on varying coefficients models <span class="citation">(<a href="#ref-hastie1993">Hastie and Tibshirani 1993</a>; <a href="#ref-eubank2004">Eubank et al. 2004</a>)</span>, implemented in <strong>tvReg</strong> and <strong>tvem</strong> packages <span class="citation">(<a href="#ref-casas2022">Casas and Fernández-Casal 2022</a>; <a href="#ref-dziak2021">Dziak et al. 2021</a>)</span>. While <strong>tvem</strong> supports multiple individuals, it does not support multiple response variables per individual. The <strong>tvReg</strong> package supports only univariate single-individual responses. Also based on SSMs and differential equations, the <strong>dynr</strong> package <span class="citation">(<a href="#ref-dynr">Ou, Hunter, and Chow 2019</a>)</span> provides methods for modeling multivariate dynamic regime-switching models with linear or non-linear latent dynamics and linear-Gaussian observations. Because both multilevel models and SEMs can be defined as SSMs <span class="citation">(see e.g., <a href="#ref-Sallas1981">Sallas and Harville 1981</a>; <a href="#ref-KFAS">Helske 2017</a>; <a href="#ref-Chow2010">Chow et al. 2010</a>)</span>, other packages supporting general SSMs could be suitable for panel data analysis in principle as well, such as <strong>KFAS</strong> <span class="citation">(<a href="#ref-KFAS">Helske 2017</a>)</span>, <strong>bssm</strong> <span class="citation">(<a href="#ref-bssm">Helske and Vihola 2021</a>)</span>, and <strong>pomp</strong> <span class="citation">(<a href="#ref-pomp">King, Nguyen, and Ionides 2016</a>)</span>. However, SSMs are often computationally demanding especially for non-Gaussian observations where the marginal likelihood is analytically intractable, and a large number of individuals can be problematic, particularly in the presence of additional group-level random effects which complicates the construction of the corresponding state space model <span class="citation">(<a href="#ref-KFAS">Helske 2017</a>)</span>.</p>
<p>The <strong>dynamite</strong> package <span class="citation">(<a href="#ref-dynamitepackage">Tikka and Helske 2024b</a>)</span> provides an alternative approach to panel data inference which avoids some of the limitations and drawbacks of the aforementioned methods. First, the dynamic multivariate panel data models (DMPMs), introduced by <span class="citation">Helske and Tikka (<a href="#ref-dmpm">2024</a>)</span> and implemented in the <strong>dynamite</strong> package support estimation of effects that vary smoothly over time according to Bayesian P-splines <span class="citation">(<a href="#ref-lang2004">Lang and Brezger 2004</a>)</span>, with penalization based on random walk priors. This allows modeling for example the effects of interventions that increase or decrease over time. Second, <strong>dynamite</strong> supports a wide variety of distributions for the response variables such as Gaussian, Poisson, binomial, and categorical distributions. Third, with <strong>dynamite</strong>, we can model an arbitrary number of simultaneous measurements per individual. Finally, the estimation is fully Bayesian using Markov chain Monte Carlo (MCMC) simulation via Stan <span class="citation">(<a href="#ref-Stan">Stan Development Team 2024b</a>)</span> leading to transparent and interpretable quantification of parameter and predictive uncertainty. A comprehensive comparison between DMPMs and other panel data modeling approaches can be found in <span class="citation">(<a href="#ref-dmpm">Helske and Tikka 2024</a>)</span>.</p>
<p>One of the most defining features of <strong>dynamite</strong> is its high-performance prediction functionality, which is fully automated, supports multi-step predictions over the entire observed time interval, and can operate at the individual level or group level. This is in stark contrast to packages such as <strong>brms</strong> where, in the presence of lagged response variables as covariates, obtaining such predictions necessitates the computation of manual stepwise predictions and can pose a challenge even for an experienced user. Furthermore, by jointly modeling all endogenous variables simultaneously, <strong>dynamite</strong> allows us to consider the long-term effects of interventions that take into account the interdependence of the variables in the model.</p>
<p>The paper is organized as follows. In Section <a href="#sec:model">2</a> we introduce the dynamic multivariate panel model which is the class of models considered in the <strong>dynamite</strong> package and describe the assumptions made in the package with respect to these models. Section <a href="#sec:dynamitepackage">3</a> introduces the software package and its core features along with two illustrative examples using a real dataset and a synthetic dataset. Sections <a href="#sec:construction">4</a> and <a href="#sec:fitting">5</a> provide a more comprehensive and technical overview of how to define and estimate models using the package. The use of the model fit objects for prediction is discussed in Section <a href="#sec:prediction">6</a>. Finally, Section <a href="#sec:summary">7</a> summarizes our contributions and provides some concluding remarks.</p>
</div>
<div class="section level2" number="2">
<h2 id="sec:model">
<span class="header-section-number">2</span> The dynamic multivariate panel model<a class="anchor" aria-label="anchor" href="#sec:model"></a>
</h2>
<p>Consider an individual <span class="math inline">\(i\)</span> at time <span class="math inline">\(t\)</span> with observations <span class="math inline">\(y_{t,i} = (y_{1,t,i},\ldots, y_{C,t,i})\)</span>, <span class="math inline">\(t=1,\ldots,T\)</span>, <span class="math inline">\(i = 1,\ldots,N\)</span>. In other words, at each time point <span class="math inline">\(t\)</span> we have <span class="math inline">\(C\)</span> observations from <span class="math inline">\(N\)</span> individuals, where <span class="math inline">\(C\)</span> is the number of different response variables that have been measured, which we call channels. The response variables can be univariate or multivariate. We assume that each element of <span class="math inline">\(y_{t,i}\)</span> can depend on the past observations <span class="math inline">\(y_{t-\ell,i}\)</span>, <span class="math inline">\(\ell=1,\ldots\)</span> (where the set of past values can be different for each channel) and also on additional exogenous covariates <span class="math inline">\(x_{t,i}\)</span>. In addition, each response variable <span class="math inline">\(y_{c,t,i}\)</span> can depend on other observations at the same time point <span class="math inline">\(t\)</span>, i.e., the elements of <span class="math inline">\(y_{t,i}\)</span>, with the following restriction. We assume that the channels can be ordered so that the distribution of <span class="math inline">\(y_{t,i}\)</span> factorizes according to an ordering <span class="math inline">\(\pi\)</span> of the responses. We denote the observations at the same time point before observation <span class="math inline">\(y_{c,t,i}\)</span> in this ordering by <span class="math inline">\(y_{\pi(c),t,i}\)</span>. Thus, the conditional distribution of channel <span class="math inline">\(c\)</span> is completely defined by the observations at the same time point before the channel in the ordering <span class="math inline">\(\pi\)</span>, past observations, exogenous covariates, and the model parameters for all <span class="math inline">\(c = 1,\ldots,C\)</span>. For simplicity of the presentation, we now assume that all channels are univariate and that the observations of each channel only depend on the previous time points, i.e., <span class="math inline">\(\ell = 1\)</span> for all channels. The set of all model parameters is denoted by <span class="math inline">\(\theta\)</span>. We treat the first <span class="math inline">\(L\)</span> timepoints as fixed data, where <span class="math inline">\(L\)</span> is the highest order of lag dependence in the model. Now, assuming that the elements of <span class="math inline">\(y_{t,i}\)</span> are conditionally independent given <span class="math inline">\(y_{t-1,i}\)</span>, <span class="math inline">\(x_{t,i}\)</span>, and <span class="math inline">\(\theta\)</span> we have
<span class="math display" id="eq:factorization">\[\begin{equation}
  y_{t,i} \sim p_t(y_{t,i} | y_{1:t-1,i},x_{t,i},\theta) = \prod_{c = 1}^C p_{c,t}(y_{c,t,i} | y_{\pi(c),t,i}, y_{1:t-1,i}, x_{t,i}, \theta),
  \tag{1}
\end{equation}\]</span>
where <span class="math inline">\(y_{1:t-1,i}\)</span> denotes the past values of the response variables across all channels <span class="math inline">\((y_{1,i},\ldots,y_{t-1,i})\)</span>. Importantly, the parameters of the conditional distributions <span class="math inline">\(p_{c,t}\)</span> can be time-dependent, enabling us to consider the evolution of the dynamics of our system over time.</p>
<p>Given a suitable link function depending on our distributional assumptions, we define a linear predictor <span class="math inline">\(\eta_{c,t,i}\)</span> for the conditional distribution <span class="math inline">\(p^c_t\)</span> of each channel <span class="math inline">\(c\)</span> with the following general form:
<span class="math display" id="eq:linpred">\[\begin{equation}
  \eta_{c,t,i} = \alpha_{c,t} + u^\top_{c,t,i} \beta_c + w^\top_{c,t,i} \delta_{c,t} + z^\top_{c,t,i} \nu_{c,i} + \lambda^\top_{c,i} \psi_{c,t},
  \tag{2}
\end{equation}\]</span>
where <span class="math inline">\(\alpha_{c,t}\)</span> is the (possibly time-varying) common intercept term, <span class="math inline">\(u^\top_{c,t,i}\)</span> defines the covariates corresponding to the vector of time-invariant coefficients <span class="math inline">\(\beta_c\)</span>, and similarly <span class="math inline">\(w^\top_{c,t,i}\)</span> defines the covariates for the time-varying coefficients <span class="math inline">\(\delta_{c,t}\)</span>. The term <span class="math inline">\(z^\top_{c,t,i} \nu_{c,i}\)</span> corresponds to individual-specific random effects, where <span class="math inline">\(\nu_{1,i},\ldots, \nu_{C,i}\)</span> are assumed to follow a zero-mean Gaussian distribution, either with a diagonal or a full covariance matrix. Note that the covariates in <span class="math inline">\(u^\top_{c,t,i}\)</span>, <span class="math inline">\(w^\top_{c,t,i}\)</span>, and <span class="math inline">\(z^\top_{c,t,i}\)</span> may contain values of other response variables at the same time point that appear before channel <span class="math inline">\(c\)</span> in the ordering <span class="math inline">\(\pi\)</span>, past observations of the response channels (or transformations of them), or exogenous covariates. Covariates in <span class="math inline">\(z^\top_{c,t,i}\)</span> can overlap those in <span class="math inline">\(u^\top_{c,t,i}\)</span> and <span class="math inline">\(w^\top_{c,t,i}\)</span> resulting in an interpretation for <span class="math inline">\(\nu_{c,i}\)</span> that corresponds to individual-specific deviations from the population-level effects <span class="math inline">\(\beta_c\)</span> and <span class="math inline">\(\delta_{c,t}\)</span>, respectively. In contrast, the covariates in <span class="math inline">\(u^\top_{c,t,i}\)</span> and <span class="math inline">\(w^\top_{c,t,i}\)</span> should in general not overlap to ensure the identifiability of their respective model parameters. The final term <span class="math inline">\(\lambda^\top_{c,i} \psi_{c,t}\)</span> is a product of latent individual loadings <span class="math inline">\(\lambda_{c,i}\)</span> and a univariate latent dynamic factor <span class="math inline">\(\psi_{c,t}\)</span>. The latent factors can be correlated across channels.</p>
<p>For the time-varying coefficients <span class="math inline">\(\delta_{c,t}\)</span> (and similarly for time-varying <span class="math inline">\(\alpha_{c,t}\)</span> and the latent factor <span class="math inline">\(\psi_{c,t}\)</span>), we use Bayesian P-splines such that
<span class="math display">\[
  \delta_{c,t,k} = b^\top_t \omega_{c,k}, \quad k=1,\ldots,K,
\]</span>
where <span class="math inline">\(K\)</span> is the number of covariates, <span class="math inline">\(b_t\)</span> is a vector of B-spline basis function values at time <span class="math inline">\(t\)</span>, and <span class="math inline">\(\omega_{c,k}\)</span> is a vector of corresponding spline coefficients. We assume a B-spline basis of equally spaced knots on the time interval from <span class="math inline">\(L+1\)</span> to <span class="math inline">\(T\)</span> with <span class="math inline">\(D\)</span> degrees of freedom. In general, the number of B-splines <span class="math inline">\(D\)</span> used for constructing the splines for the study period <span class="math inline">\(1,\ldots,T\)</span> can be chosen freely, but the actual value is not too important <span class="citation">(as long as <span class="math inline">\(D\)</span> is larger than the degree of the spline, e.g., three for cubic splines, <a href="#ref-Wood2020">Wood 2020</a>)</span>. Therefore, we use the same <span class="math inline">\(D\)</span> basis functions for all time-varying effects. To mitigate overfitting due to too large a value of <span class="math inline">\(D\)</span>, we define a random walk prior <span class="citation">(<a href="#ref-lang2004">Lang and Brezger 2004</a>)</span> for <span class="math inline">\(\omega_{c,k}\)</span> as
<span class="math display">\[
  \omega_{c,k,1} \sim p(\omega_{c,k,1}), \quad
  \omega_{c,k,d} \sim N(\omega_{c,k,d-1}, \tau^2_{c,k}), \quad d=2, \ldots, D,
\]</span>
with a user-defined prior <span class="math inline">\(p(\omega_{c,k,1})\)</span> on the first coefficient, which due to the structure of <span class="math inline">\(b_1\)</span> corresponds to a prior on <span class="math inline">\(\delta_{c,k,1}\)</span>. Here, the parameter <span class="math inline">\(\tau_{c,k}\)</span> controls the smoothness of the spline curves. While the different time-varying coefficients are modeled as independent a priori, the latent factors <span class="math inline">\(\psi_{c,t}\)</span> can be modeled as correlated via correlated spline coefficients <span class="math inline">\(\omega_{c,k}\)</span>. See Appendix <a href="#app:latentfactor">A</a> for the details of the parametrization of the latent factor term.</p>
<p>For categorical, multivariate, and other distributions with multiple dimensions or components, we can extend the definition of the linear predictor in Equation <a href="#eq:linpred">(2)</a> to account for each dimension by simply replacing the index <span class="math inline">\(c\)</span> with indices <span class="math inline">\(c,s\)</span> where <span class="math inline">\(s\)</span> denotes the index of the dimension, <span class="math inline">\(s = 1,\ldots,S(c)\)</span>, and <span class="math inline">\(S(c)\)</span> is the number of dimensions of channel <span class="math inline">\(c\)</span>. This extension also applies to the spline coefficients.</p>
</div>
<div class="section level2" number="3">
<h2 id="sec:dynamitepackage">
<span class="header-section-number">3</span> The <code>dynamite</code> package<a class="anchor" aria-label="anchor" href="#sec:dynamitepackage"></a>
</h2>
<p>The <strong>dynamite</strong> package provides an easy-to-use interface for fitting DMPMs in R. As the package is part of rOpenSci (<a href="https://ropensci.org" class="external-link uri">https://ropensci.org</a>), it complies with its rigorous software standards and the development version of <strong>dynamite</strong> can be installed from the R-universe system (<a href="https://ropensci.org/r-universe/" class="external-link uri">https://ropensci.org/r-universe/</a>). The stable version of the package is available from CRAN at (<a href="https://cran.r-project.org/package=dynamite" class="external-link uri">https://cran.r-project.org/package=dynamite</a>). The software is published under the GNU general public license (GPL <span class="math inline">\(\geq\)</span> 3) and can be obtained in R by running the following commands:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"dynamite"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://docs.ropensci.org/dynamite/">"dynamite"</a></span><span class="op">)</span></span></code></pre></div>
<p>The package takes advantage of several other well-established R packages. Estimation of the models is carried out by Stan for which both <strong>rstan</strong> and <strong>cmdstanr</strong> interfaces are available <span class="citation">(<a href="#ref-rstan">Stan Development Team 2024a</a>; <a href="#ref-cmdstanr">Gabry and Češnovar 2023</a>)</span>. More specifically, the MCMC simulation uses the No-U-Turn sampler <span class="citation">(NUTS, <a href="#ref-hoffman2014">Hoffman and Gelman 2014</a>)</span> which is an extension of Hamiltonian Monte Carlo <span class="citation">(HMC, <a href="#ref-Neal2011">Neal 2011</a>)</span>. The <strong>data.table</strong> package <span class="citation">(<a href="#ref-datatable">Barrett et al. 2024</a>)</span> is used for efficient computation and memory management of predictions and internal data manipulations. For posterior inference and visualization, <strong>ggplot2</strong> and <strong>posterior</strong> packages are leveraged <span class="citation">(<a href="#ref-ggplot2">Wickham 2016</a>; <a href="#ref-posterior">Bürkner et al. 2023</a>)</span>. Leave-one-out (LOO) and leave-future-out (LFO) cross-validation methods are implemented with the help of the <strong>loo</strong> package <span class="citation">(<a href="#ref-loo">Vehtari et al. 2022</a>)</span>. All of the aforementioned dependencies are available on CRAN except for <strong>cmdstanr</strong> whose installation is optional and needed only if the user wishes to use the <strong>CmdStan</strong> backend for Stan. Although not required for <strong>dynamite</strong>, we also install the <strong>dplyr</strong>, <strong>pder</strong>, and <strong>pryr</strong> packages <span class="citation">(<a href="#ref-dplyr">Wickham et al. 2023</a>; <a href="#ref-pder">Croissant and Millo 2022</a>; <a href="#ref-pryr">Wickham 2023</a>)</span>, as we will use them in the subsequent sections.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"dplyr"</span>, <span class="st">"pder"</span>, <span class="st">"pryr"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Several example datasets and corresponding model fit objects are included in <strong>dynamite</strong> which are used throughout this paper for illustrative purposes. The script files to generate these datasets and the model fit objects can be found in the package GitHub repository (<a href="https://https://github.com/ropensci/dynamite/" class="external-link uri">https://https://github.com/ropensci/dynamite/</a>) under the <code>data-raw</code> directory. Table <a href="#tab:dynamitefuns">1</a> provides an overview of the available functions and methods of the package. Before presenting the technical details, we demonstrate the key features of the package and the general workflow by performing an illustrative analysis on a real dataset and a synthetic dataset.</p>
<table class="table">
<caption>
<span id="tab:dynamitefuns">Table 1: </span> The functionality of <strong>dynamite</strong>. Asterisks denote <code>"dynamitefit"</code> methods that are also available for <code>"dynamiteformula"</code> objects.</caption>
<colgroup>
<col width="26%">
<col width="21%">
<col width="52%">
</colgroup>
<thead><tr class="header">
<th>Function</th>
<th>Output</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code><a href="../reference/dynamite.html">dynamite()</a></code></td>
<td><code>"dynamitefit"</code></td>
<td>Estimate a dynamic multivariate panel model</td>
</tr>
<tr class="even">
<td><code><a href="../reference/dynamice.html">dynamice()</a></code></td>
<td><code>"dynamitefit"</code></td>
<td>Estimate a DMPM with multiple imputation</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/dynamiteformula.html">dynamiteformula()</a></code></td>
<td><code>"dynamiteformula"</code></td>
<td>Define a response channel</td>
</tr>
<tr class="even">
<td><code>+.dynamiteformula()</code></td>
<td><code>"dynamiteformula"</code></td>
<td>Add definitions to a model formula</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/dynamiteformula.html">obs()</a></code></td>
<td><code>"dynamiteformula"</code></td>
<td>Define a response channel (alias)</td>
</tr>
<tr class="even">
<td><code><a href="../reference/dynamiteformula.html">aux()</a></code></td>
<td><code>"dynamiteformula"</code></td>
<td>Define a deterministic channel</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/splines.html">splines()</a></code></td>
<td><code>"splines"</code></td>
<td>Define P-splines for time-varying coefficients</td>
</tr>
<tr class="even">
<td><code><a href="../reference/random_spec.html">random_spec()</a></code></td>
<td><code>"random_spec"</code></td>
<td>Define additional properties of random effects</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/lags.html">lags()</a></code></td>
<td><code>"lags"</code></td>
<td>Define lagged covariates for all channels</td>
</tr>
<tr class="even">
<td><code><a href="../reference/lfactor.html">lfactor()</a></code></td>
<td><code>"lfactor"</code></td>
<td>Define latent factors</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code></td>
<td><code>"data.frame"</code></td>
<td>Extract posterior samples or summaries</td>
</tr>
<tr class="even">
<td><code><a href="../reference/as.data.table.dynamitefit.html">as.data.table()</a></code></td>
<td><code>"data.table"</code></td>
<td>Extract posterior samples or summaries</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/as_draws-dynamitefit.html">as_draws()</a></code></td>
<td><code>"draws_df"</code></td>
<td>Extract posterior samples or summaries</td>
</tr>
<tr class="even">
<td><code><a href="../reference/as_draws-dynamitefit.html">as_draws_df()</a></code></td>
<td><code>"draws_df"</code></td>
<td>Extract posterior samples or summaries</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code></td>
<td><code>"tbl_df"</code></td>
<td>Extract posterior samples or summaries</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/confint.html" class="external-link">confint()</a></code></td>
<td><code>"matrix"</code></td>
<td>Extract credible intervals</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code></td>
<td><code>"data.table"</code></td>
<td>Compute fitted values</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/formula.html" class="external-link">formula()</a></code></td>
<td><code>"language"</code></td>
<td>Extract the model formula</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/get_code.html">get_code()</a></code></td>
<td><code>"data.frame"</code></td>
<td>Extract the Stan model code*</td>
</tr>
<tr class="even">
<td><code><a href="../reference/get_data.html">get_data()</a></code></td>
<td><code>"list"</code></td>
<td>Extract the data used to fit the model*</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/get_parameter_dims.html">get_parameter_dims()</a></code></td>
<td><code>"list"</code></td>
<td>Extract parameter dimensions*</td>
</tr>
<tr class="even">
<td><code><a href="../reference/get_parameter_names.html">get_parameter_names()</a></code></td>
<td><code>"character"</code></td>
<td>Extract parameter names</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/get_parameter_types.html">get_parameter_types()</a></code></td>
<td><code>"character"</code></td>
<td>Extract parameter types</td>
</tr>
<tr class="even">
<td><code><a href="../reference/get_priors.html">get_priors()</a></code></td>
<td><code>"data.frame"</code></td>
<td>Extract the prior distribution definitions*</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/hmc_diagnostics.html">hmc_diagnostics()</a></code></td>
<td><code>"dynamitefit"</code></td>
<td>Compute HMC diagnostics</td>
</tr>
<tr class="even">
<td><code><a href="../reference/lfo.html">lfo()</a></code></td>
<td><code>"lfo"</code></td>
<td>Compute LFO cross-validation for the model</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/loo.dynamitefit.html">loo()</a></code></td>
<td><code>"loo"</code></td>
<td>Compute LOO cross-validation for the model</td>
</tr>
<tr class="even">
<td><code><a href="../reference/mcmc_diagnostics.html">mcmc_diagnostics()</a></code></td>
<td><code>"dynamitefit"</code></td>
<td>Compute MCMC diagnostics</td>
</tr>
<tr class="odd">
<td><code><a href="../reference/ndraws.dynamitefit.html">ndraws()</a></code></td>
<td><code>"integer"</code></td>
<td>Extract the number of posterior draws</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/nobs.html" class="external-link">nobs()</a></code></td>
<td><code>"integer"</code></td>
<td>Extract the number of observations</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code></td>
<td><code>"ggplot"</code></td>
<td>Visualize posterior distributions</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code></td>
<td><code>"data.frame"</code></td>
<td>Compute predictions</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code></td>
<td><code>"dynamitefit"</code></td>
<td>Print information on the model fit*</td>
</tr>
<tr class="even">
<td><code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code></td>
<td><code>"data.frame"</code></td>
<td>Print a summary of the model fit</td>
</tr>
<tr class="odd">
<td><code><a href="https://rdrr.io/r/stats/update.html" class="external-link">update()</a></code></td>
<td><code>"dynamitefit"</code></td>
<td>Update the model fit</td>
</tr>
</tbody>
</table>
<div class="section level3" number="3.1">
<h3 id="sec:seatbelt">
<span class="header-section-number">3.1</span> Bayesian inference of seat belt usage and traffic fatalities<a class="anchor" aria-label="anchor" href="#sec:seatbelt"></a>
</h3>
<p>As the first illustration, we consider the effect of seat belt laws on traffic fatalities using data from the <strong>pder</strong> package, originally analyzed by <span class="citation">Cohen and Einav (<a href="#ref-Cohen2003">2003</a>)</span>. The data consists of the number of traffic fatalities and other related variables in the United States from all 51 states for every year from 1983 to 1997. During this time, many states passed laws regarding mandatory seat belt use. We distinguish two types of laws: secondary enforcement law and primary enforcement law. Secondary enforcement means that the police can fine violators only when they are stopped for other offenses, whereas in primary enforcement the police can also stop and fine based on the seat belt use violation itself. This dataset is named <code>SeatBelt</code> and it can be loaded into the current R session by running:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="st">"SeatBelt"</span>, package <span class="op">=</span> <span class="st">"pder"</span><span class="op">)</span></span></code></pre></div>
<p>To begin, we rename some variables and compute additional transformations to make the subsequent analyses straightforward.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://dplyr.tidyverse.org" class="external-link">"dplyr"</a></span><span class="op">)</span></span>
<span><span class="va">seatbelt</span> <span class="op">&lt;-</span> <span class="va">SeatBelt</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    miles <span class="op">=</span> <span class="op">(</span><span class="va">vmturban</span> <span class="op">+</span> <span class="va">vmtrural</span><span class="op">)</span> <span class="op">/</span> <span class="fl">10000</span>,</span>
<span>    log_miles <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">miles</span><span class="op">)</span>,</span>
<span>    fatalities <span class="op">=</span> <span class="va">farsocc</span>,</span>
<span>    income10000 <span class="op">=</span> <span class="va">percapin</span> <span class="op">/</span> <span class="fl">10000</span>,</span>
<span>    law <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html" class="external-link">case_when</a></span><span class="op">(</span></span>
<span>        <span class="va">dp</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"primary"</span>,</span>
<span>        <span class="va">dsp</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">~</span> <span class="st">"primary"</span>,</span>
<span>        <span class="va">ds</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">dsp</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="st">"secondary"</span>,</span>
<span>        <span class="cn">TRUE</span> <span class="op">~</span> <span class="st">"no_law"</span></span>
<span>      <span class="op">)</span>,</span>
<span>      levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"no_law"</span>, <span class="st">"secondary"</span>, <span class="st">"primary"</span><span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We are interested in the effect of the seat belt law on traffic fatalities in terms of car occupants via the changes in seat belt usage. For this purpose, we build a joint model for seat belt usage and fatalities. We model the rate of seat belt usage with a beta distribution (with a logit link) and assume that the usage depends on the level of the seat belt law, state-level effects (modeled as random intercepts), and overall time-varying trend (modeled as a spline), which captures potential changes in the general tendency to use a seat belt in the US. We model the number of fatalities with a negative binomial distribution (with a log link) using the total miles traveled as an offset. In addition to the seat belt usage and state-level random intercepts, we also use several other variables related to traffic density, speed limit, alcohol usage, and income (see <code><a href="https://rdrr.io/pkg/pder/man/SeatBelt.html" class="external-link">?pder::SeatBelt</a></code> for details) as controls. First, we construct the model formula that defines the distributions of the response channels, the covariates of each channel, and the splines used for the time-varying effects:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seatbelt_formula</span> <span class="op">&lt;-</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">usage</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">law</span> <span class="op">+</span> <span class="fu">random</span><span class="op">(</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span></span>
<span>    <span class="va">fatalities</span> <span class="op">~</span> <span class="va">usage</span> <span class="op">+</span> <span class="va">densurb</span> <span class="op">+</span> <span class="va">densrur</span> <span class="op">+</span></span>
<span>      <span class="va">bac08</span> <span class="op">+</span> <span class="va">mlda21</span> <span class="op">+</span> <span class="va">lim65</span> <span class="op">+</span> <span class="va">lim70p</span> <span class="op">+</span> <span class="va">income10000</span> <span class="op">+</span> <span class="va">unemp</span> <span class="op">+</span> <span class="va">fueltax</span> <span class="op">+</span></span>
<span>      <span class="fu">random</span><span class="op">(</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">log_miles</span><span class="op">)</span>, </span>
<span>    family <span class="op">=</span> <span class="st">"negbin"</span></span>
<span>  <span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/splines.html">splines</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>Next, we fit the model</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamite.html">dynamite</a></span><span class="op">(</span></span>
<span>  dformula <span class="op">=</span> <span class="va">seatbelt_formula</span>,</span>
<span>  data <span class="op">=</span> <span class="va">seatbelt</span>, time <span class="op">=</span> <span class="st">"year"</span>, group <span class="op">=</span> <span class="st">"state"</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, refresh <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can extract the estimated coefficients with the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> method which shows clear positive effects for both secondary enforcement and primary enforcement laws:</p>
<pre><code><span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 5</span></span></span>
<span><span class="co">#&gt;   parameter                mean     sd    q5   q95</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>                   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> beta_usage_lawsecondary 0.495 0.047<span style="text-decoration: underline;">3</span> 0.416 0.572</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> beta_usage_lawprimary   1.05  0.086<span style="text-decoration: underline;">4</span> 0.907 1.19</span></span></code></pre>
<p>While these coefficients can be interpreted as changes in log-odds as usual, we also estimate the marginal means using the <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> method which returns the posterior samples of the expected values of the responses at each time point given the covariates. For this purpose, we create a new data frame for each level of the <code>law</code> factor and assign every state to uphold this particular law. We then call <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> using these data, compute the averages of over the states and finally over the posterior samples:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seatbelt_new</span> <span class="op">&lt;-</span> <span class="va">seatbelt</span></span>
<span><span class="va">seatbelt_new</span><span class="op">$</span><span class="va">law</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"no_law"</span></span>
<span><span class="va">pnl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">seatbelt_new</span><span class="op">)</span></span>
<span><span class="va">seatbelt_new</span><span class="op">$</span><span class="va">law</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"secondary"</span></span>
<span><span class="va">psl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">seatbelt_new</span><span class="op">)</span></span>
<span><span class="va">seatbelt_new</span><span class="op">$</span><span class="va">law</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"primary"</span></span>
<span><span class="va">ppl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">seatbelt_new</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>no_law <span class="op">=</span> <span class="va">pnl</span>, secondary <span class="op">=</span> <span class="va">psl</span>, primary <span class="op">=</span> <span class="va">ppl</span>, .id <span class="op">=</span> <span class="st">"law"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span></span>
<span>    law <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">law</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"no_law"</span>, <span class="st">"secondary"</span>, <span class="st">"primary"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">law</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mm <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">usage_fitted</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">law</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mm</span><span class="op">)</span>,</span>
<span>    q5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mm</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mm</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 3 × 4</span></span></span>
<span><span class="co">#&gt;   law        mean    q5   q95</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> no_law    0.359 0.346 0.373</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> secondary 0.468 0.458 0.477</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> primary   0.591 0.566 0.616</span></span></code></pre></div>
<p>These estimates are in line with the results of <span class="citation">Cohen and Einav (<a href="#ref-Cohen2003">2003</a>)</span> who report the law effects on seat belt usage as increases of 11 and 22 percentage points for secondary enforcement and primary enforcement laws, respectively.</p>
<p>For the effect of seat belt laws on the number of traffic fatalities, we compare the number of fatalities with 68% seat belt usage against 90% usage. These values, coinciding with the national average in 1996 and the target of 2005, were also used by who reported an increase in annual lives saved as 1500–3000. We do this by comparing the differences in total fatalities across states for each year, and by averaging over the years, again with the help of the <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> method;</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">seatbelt_new</span> <span class="op">&lt;-</span> <span class="va">seatbelt</span></span>
<span><span class="va">seatbelt_new</span><span class="op">$</span><span class="va">usage</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.68</span></span>
<span><span class="va">p68</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">seatbelt_new</span><span class="op">)</span></span>
<span><span class="va">seatbelt_new</span><span class="op">$</span><span class="va">usage</span><span class="op">[</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.90</span></span>
<span><span class="va">p90</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted</a></span><span class="op">(</span><span class="va">fit</span>, newdata <span class="op">=</span> <span class="va">seatbelt_new</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>low <span class="op">=</span> <span class="va">p68</span>, high <span class="op">=</span> <span class="va">p90</span>, .id <span class="op">=</span> <span class="st">"usage"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">year</span>, <span class="va">.draw</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    s <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span></span>
<span>      <span class="va">fatalities_fitted</span><span class="op">[</span><span class="va">usage</span> <span class="op">==</span> <span class="st">"low"</span><span class="op">]</span> <span class="op">-</span></span>
<span>        <span class="va">fatalities_fitted</span><span class="op">[</span><span class="va">usage</span> <span class="op">==</span> <span class="st">"high"</span><span class="op">]</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.draw</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">s</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span>,</span>
<span>    q5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">0.05</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">m</span>, <span class="fl">0.95</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 3</span></span></span>
<span><span class="co">#&gt;    mean    q5   q95</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> <span style="text-decoration: underline;">1</span>553.  787. <span style="text-decoration: underline;">2</span>311.</span></span></code></pre></div>
<p>In this example, the model did not contain any lagged responses as covariates, so it was enough to compute predictions for each time point essentially independently using the <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> method. However, when the responses depend on the past values of themselves or of other channels, as is the case for example in cross-lagged panel models, estimating long-term causal effects such as <span class="math inline">\(E(y_{t+k} | do(y_t)), k = 1,\ldots\)</span>, where <span class="math inline">\(do(y_t)\)</span> denotes an intervention on <span class="math inline">\(y_t\)</span> <span class="citation">(<a href="#ref-Pearl2009">Pearl 2009</a>)</span>, is more complicated. We illustrate this in our next example.</p>
</div>
<div class="section level3" number="3.2">
<h3 id="sec:multichannel">
<span class="header-section-number">3.2</span> Causal effects in a multichannel model<a class="anchor" aria-label="anchor" href="#sec:multichannel"></a>
</h3>
<p>We consider the following simulated multichannel data available in the <strong>dynamite</strong> package and the estimation of causal effects.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">multichannel_example</span><span class="op">)</span></span>
<span><span class="co">#&gt;   id time          g  p b</span></span>
<span><span class="co">#&gt; 1  1    1 -0.6264538  5 1</span></span>
<span><span class="co">#&gt; 2  1    2 -0.2660091 12 0</span></span>
<span><span class="co">#&gt; 3  1    3  0.4634939  9 1</span></span>
<span><span class="co">#&gt; 4  1    4  1.0451444 15 1</span></span>
<span><span class="co">#&gt; 5  1    5  1.7131026 10 1</span></span>
<span><span class="co">#&gt; 6  1    6  2.1382398  8 1</span></span></code></pre></div>
<p>The data contains 50 unique groups (variable <code>id</code>), over 20 time points (<code>time</code>), a continuous variable <span class="math inline">\(g_t\)</span> (<code>g</code>), a variable with non-negative integer
values <span class="math inline">\(p_t\)</span> (<code>p</code>), and a binary variable <span class="math inline">\(b_t\)</span> (<code>b</code>). We define the following model (which actually matches the data-generating process used to generate the data):</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multi_formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">g</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">logp</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">p</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">logp</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">b</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">logp</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">b</span><span class="op">)</span> <span class="op">*</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">g</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"bernoulli"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">aux</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">logp</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">p</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span> <span class="op">|</span> <span class="fu">init</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here, the <code><a href="../reference/dynamiteformula.html">aux()</a></code> function creates a deterministic transformation of <span class="math inline">\(p_t\)</span> defined as <span class="math inline">\(\log(p_t + 1)\)</span> which can subsequently be used in other channels as a covariate and correctly computes the transformation for predictions. Because the model also contains a lagged value of <code>logp</code>, we define the initial value of <code>logp</code> to be 0 at the first time point via the <code>past()</code> declaration. Without the initial value, we would receive a warning message when fitting the model, but in this case we could safely ignore the warning because the model contains lags of <code>b</code> and <code>g</code> as well meaning that the first time point in the model is treated as fixed and does not enter the model fitting process. This makes the <code>past()</code> declaration redundant in this instance, but it is good practice to always define the initial values of deterministic channels when the model contains their lagged values to avoid accidental <code>NA</code> values when the channel is evaluated. A directed acyclic graph (DAG) that depicts the causal relationships of the variables in the model is shown in Figure <a href="#fig:multichanneldag">1</a>. We fit the model using the <code><a href="../reference/dynamite.html">dynamite()</a></code> function.</p>
<div class="float">
<img src="dag.png" style="width:80.0%" alt=" A directed acyclic graph for the multichannel model with arrows corresponding to the assumed direct causal effects. A cross-section at times t, t+1, and t+2 is shown. The vertices and edges corresponding to the deterministic tranformation \log(p_t) are omitted for clarity."><div class="figcaption"> A directed acyclic graph for the multichannel model with arrows corresponding to the assumed direct causal effects. A cross-section at times <span class="math inline">\(t\)</span>, <span class="math inline">\(t+1\)</span>, and <span class="math inline">\(t+2\)</span> is shown. The vertices and edges corresponding to the deterministic tranformation <span class="math inline">\(\log(p_t)\)</span> are omitted for clarity.</div>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multichannel_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamite.html">dynamite</a></span><span class="op">(</span></span>
<span>  dformula <span class="op">=</span> <span class="va">multi_formula</span>,</span>
<span>  data <span class="op">=</span> <span class="va">multichannel_example</span>, time <span class="op">=</span> <span class="st">"time"</span>, group <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">4</span>, refresh <span class="op">=</span> <span class="fl">0</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We can obtain posterior samples or summary statistics of the model using the <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code>, <code><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef()</a></code>, and <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> methods, but here we opt for visualizing the results as depicted in Figure <a href="#fig:multichannelbetas">2</a> by using the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme_get.html" class="external-link">theme_set</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">multichannel_fit</span>, types <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:multichannelbetas"></span>
<img src="dynamite_files/figure-html/multichannelbetas-1.png" alt="Posterior means and 90% posterior intervals of the time-invariant coefficients for the multichannel model." width="100%"><p class="caption">
Figure 2: Posterior means and 90% posterior intervals of the time-invariant coefficients for the multichannel model.
</p>
</div>
<p>Note the naming of the model parameters; for example, <code>beta_b_g_lag1</code> corresponds to a time-invariant coefficient <code>beta</code> for channel <code>b</code> of the lagged covariate <code>g</code>.</p>
<p>Assume now that we are interested in the causal effect of <span class="math inline">\(b_5\)</span> on <span class="math inline">\(g_t\)</span> at times <span class="math inline">\(t = 6, \ldots, 20\)</span>. There is no direct effect from <span class="math inline">\(b_5\)</span> to <span class="math inline">\(g_6\)</span>, but because <span class="math inline">\(g_t\)</span> affects <span class="math inline">\(b_{t+1}\)</span> (and <span class="math inline">\(p_{t+1}\)</span>), which in turn affects all variables at <span class="math inline">\(t+2\)</span>, we should see an indirect effect of <span class="math inline">\(b_5\)</span> to <span class="math inline">\(g_t\)</span> from time <span class="math inline">\(t = 7\)</span> onward. For this task, we first create a new dataset where the values of our response variables after time <span class="math inline">\(t = 5\)</span> are assigned to be missing.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multichannel_newdata</span> <span class="op">&lt;-</span> <span class="va">multichannel_example</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html" class="external-link">across</a></span><span class="op">(</span><span class="va">g</span><span class="op">:</span><span class="va">b</span>, <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="fl">5</span>, <span class="cn">NA</span>, <span class="va">.x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We then obtain predictions for time points <span class="math inline">\(t = 6,\ldots,20\)</span> when <span class="math inline">\(b_t\)</span> is assigned to be 0 or 1 for every individual at time <span class="math inline">\(t = 5\)</span>, corresponding to the interventions <span class="math inline">\(do(b_5 = 0)\)</span> and <span class="math inline">\(do(b_5 = 1)\)</span>.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">new0</span> <span class="op">&lt;-</span> <span class="va">multichannel_newdata</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fl">5</span>, <span class="fl">0</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pred0</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">multichannel_fit</span>, newdata <span class="op">=</span> <span class="va">new0</span>, type <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span>
<span><span class="va">new1</span> <span class="op">&lt;-</span> <span class="va">multichannel_newdata</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">time</span> <span class="op">==</span> <span class="fl">5</span>, <span class="fl">1</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pred1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">multichannel_fit</span>, newdata <span class="op">=</span> <span class="va">new1</span>, type <span class="op">=</span> <span class="st">"mean"</span><span class="op">)</span></span></code></pre></div>
<p>By default, the output from <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> is a single data frame containing the original new data and the samples from the posterior predictive distribution of new observations. By defining <code>type = "mean"</code>, we specify that we are interested in the posterior distribution of the expected values instead. In this case, the predicted values in the output are in the columns <code>g_mean</code>, <code>p_mean</code>, and <code>b_mean</code> where the <code>NA</code> values of the <code>newdata</code> argument are replaced with the posterior predictive samples from the model (the output also contains an additional column corresponding to the auxiliary channel <code>logp</code> and posterior draw index variable <code>.draw</code>).</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred0</span>, n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fl">3</span><span class="op">)</span></span>
<span><span class="co">#&gt;    id time .draw g_mean p_mean b_mean  logp      g  p  b</span></span>
<span><span class="co">#&gt; 1   1    1     1     NA     NA     NA 1.792 -0.626  5  1</span></span>
<span><span class="co">#&gt; 2   1    2     1     NA     NA     NA 2.565 -0.266 12  0</span></span>
<span><span class="co">#&gt; 3   1    3     1     NA     NA     NA 2.303  0.463  9  1</span></span>
<span><span class="co">#&gt; 4   1    4     1     NA     NA     NA 2.773  1.045 15  1</span></span>
<span><span class="co">#&gt; 5   1    5     1     NA     NA     NA 2.398  1.713 10  0</span></span>
<span><span class="co">#&gt; 6   1    6     1  1.853  3.592  0.698 1.099     NA NA NA</span></span>
<span><span class="co">#&gt; 7   1    7     1  1.720  3.736  0.726 1.099     NA NA NA</span></span>
<span><span class="co">#&gt; 8   1    8     1  1.666  1.409  0.729 0.693     NA NA NA</span></span>
<span><span class="co">#&gt; 9   1    9     1  1.225  1.200  0.706 1.099     NA NA NA</span></span>
<span><span class="co">#&gt; 10  1   10     1  1.416  4.148  0.704 1.792     NA NA NA</span></span></code></pre></div>
<p>We can now compute summary statistics over the individuals and then over the posterior samples to obtain the posterior distribution of the expected causal effects <span class="math inline">\(E(g_t | do(b_5))\)</span> as</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sumr</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b0 <span class="op">=</span> <span class="va">pred0</span>, b1 <span class="op">=</span> <span class="va">pred1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"case"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">case</span>, <span class="va">.draw</span>, <span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span>mean_t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">g_mean</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">case</span>, <span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mean_t</span><span class="op">)</span>,</span>
<span>    q5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mean_t</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mean_t</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>It is also possible to perform the marginalization over groups within <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> by using the <code>funs</code> argument, which can be used to provide a named list of lists of functions to be applied for the corresponding channel. This approach can save a considerable amount of memory in case of a large number of observations and groups. The names of the outermost list should be channel names. The output is now returned as a <code>"list"</code> with two components, <code>simulated</code> and <code>observed</code>, with the new samples and the original <code>newdata</code> respectively. In our case, we can write</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred0b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">multichannel_fit</span>, newdata <span class="op">=</span> <span class="va">new0</span>, type <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>g <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean_t <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">simulated</span></span>
<span><span class="va">pred1b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">multichannel_fit</span>, newdata <span class="op">=</span> <span class="va">new1</span>, type <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>g <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean_t <span class="op">=</span> <span class="va">mean</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span><span class="op">$</span><span class="va">simulated</span></span>
<span><span class="va">sumrb</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b0 <span class="op">=</span> <span class="va">pred0b</span>, b1 <span class="op">=</span> <span class="va">pred1b</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"case"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">case</span>, <span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mean_t_g</span><span class="op">)</span>,</span>
<span>    q5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mean_t_g</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mean_t_g</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The resulting data frame <code>sumrb</code> is equal to the previous <code>sumr</code> (apart from stochasticity due to the simulation of new trajectories). We can then visualize our predictions as shown in Figure <a href="#fig:multichannelvisual">3</a> by writing:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sumr</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">q5</span>, ymax <span class="op">=</span> <span class="va">q95</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>n.breaks <span class="op">=</span> <span class="fl">10</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">case</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:multichannelvisual"></span>
<img src="dynamite_files/figure-html/multichannelvisual-1.png" alt="Expected causal effects of interventions \(do(b_5 = 0)\) and \(do(b_5 = 1)\) on \(g_t\). The black lines show the posterior means and the gray areas show 90\% posterior intervals." width="100%"><p class="caption">
Figure 3: Expected causal effects of interventions <span class="math inline">\(do(b_5 = 0)\)</span> and <span class="math inline">\(do(b_5 = 1)\)</span> on <span class="math inline">\(g_t\)</span>. The black lines show the posterior means and the gray areas show 90% posterior intervals.
</p>
</div>
<p>Predictions for the first 5 time points in <code>sumr</code> are <code>NA</code> for all groups by design because our new data supplied to the <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method for both interventions contained observations for those time points, which is why we set <code>na.rm = TRUE</code> to avoid a warning in the above code. Note that these estimates do indeed coincide with the causal effects (assuming of course that our model is correct), as we can apply the backdoor adjustment formula <span class="citation">(<a href="#ref-Pearl1995">Pearl 1995</a>)</span> to obtain the expected causal effect:
<span class="math display">\[
   E(g_t | do(b_5 = x)) = \int E(g_t | b_5 = x, g_5, p_5)P(g_5, p_5)\,dg_5 dp_5,
\]</span>
where the integral over <span class="math inline">\(p_5\)</span> should be understood as a sum as <span class="math inline">\(p_5\)</span> is discrete. In the code above, <code>mean_t</code> is the estimate of this expected value. In addition, we compute an estimate of the difference
<span class="math display">\[
   E(g_t | do(b_5 = 1)) -  E(g_t | do(b_5 = 0)),
\]</span>
to directly compare the effects of the interventions by writing:</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sumr_diff</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>b0 <span class="op">=</span> <span class="va">pred0</span>, b1 <span class="op">=</span> <span class="va">pred1</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html" class="external-link">bind_rows</a></span><span class="op">(</span>.id <span class="op">=</span> <span class="st">"case"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">.draw</span>, <span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    mean_t <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">g_mean</span><span class="op">[</span><span class="va">case</span> <span class="op">==</span> <span class="st">"b1"</span><span class="op">]</span> <span class="op">-</span> <span class="va">g_mean</span><span class="op">[</span><span class="va">case</span> <span class="op">==</span> <span class="st">"b0"</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html" class="external-link">group_by</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html" class="external-link">summarize</a></span><span class="op">(</span></span>
<span>    mean <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">mean_t</span><span class="op">)</span>,</span>
<span>    q5 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mean_t</span>, <span class="fl">0.05</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    q95 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">mean_t</span>, <span class="fl">0.95</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can also plot the difference between the expected causal effects as shown in Figure <a href="#fig:multichannelcausaldiffplot">4</a> by running:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">sumr_diff</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">mean</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">q5</span>, ymax <span class="op">=</span> <span class="va">q95</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>n.breaks <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:multichannelcausaldiffplot"></span>
<img src="dynamite_files/figure-html/multichannelcausaldiffplot-1.png" alt="Difference between the expected causal effects \(E(g_t | do(b_5 = 1)) - E(g_t | do(b_5 = 0)) \). The black line shows the posterior mean and the gray area shows a 90\% posterior interval." width="100%"><p class="caption">
Figure 4: Difference between the expected causal effects <span class="math inline">\(E(g_t | do(b_5 = 1)) - E(g_t | do(b_5 = 0))\)</span>. The black line shows the posterior mean and the gray area shows a 90% posterior interval.
</p>
</div>
<p>This shows that there is a short-term effect of <span class="math inline">\(b_5\)</span> on <span class="math inline">\(g_t\)</span> where the size of the effect diminishes towards zero in time, although the posterior uncertainty is quite large.</p>
</div>
</div>
<div class="section level2" number="4">
<h2 id="sec:construction">
<span class="header-section-number">4</span> Model construction<a class="anchor" aria-label="anchor" href="#sec:construction"></a>
</h2>
<p>Here we describe the various model components that can be included in the model formulas of the <strong>dynamite</strong> package. These components are modular and easily combined in any order via a specialized <code>+</code> operator while ensuring that the model formula is well-defined and syntactically valid before estimating the model. The model formula components define the response channels, auxiliary channels, the splines used for time-varying coefficients, correlated random effects, and latent factors.</p>
<div class="section level3" number="4.1">
<h3 id="sec:defining">
<span class="header-section-number">4.1</span> Defining response channels<a class="anchor" aria-label="anchor" href="#sec:defining"></a>
</h3>
<p>The response channels are defined by combining the channel-specific formulas defined via the function <code><a href="../reference/dynamiteformula.html">dynamiteformula()</a></code> for which a shorthand alias <code><a href="../reference/dynamiteformula.html">obs()</a></code> is also provided. We will henceforth use this alias for brevity. The function <code><a href="../reference/dynamiteformula.html">obs()</a></code> takes three arguments: <code>formula</code>, <code>family</code>, and <code>link</code> which define how the response variable of the channel depends on the covariates in the standard R formula syntax, the family of the response variable as a <code>"character"</code> string, and the link function to use as a <code>"character"</code> string, respectively. The link function specification is optional with each <code>family</code> having a default link. The channel-specific definitions are combined into a single model definition with the <code>+</code> operator of <code>"dynamiteformula"</code> objects. For example, the following formula</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dform</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>defines a model with two channels. First, we declare that <code>y</code> is a Gaussian response variable depending on the previous value of <code>x</code> (<code>lag(x)</code>). Next, we add a second channel declaring <code>x</code> as Poisson distributed depending on an exogenous variable <code>z</code> (for which we do not define any distribution). Note that the model formula can be defined without referencing any external data, just like an R formula can. The model formula is an object of class <code>"dynamiteformula"</code> for which the <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> method provides a summary of the defined channels, including the response variable names, the channel families and formulas, and other model components:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">dform</span><span class="op">)</span></span>
<span><span class="co">#&gt;   Family   Formula   </span></span>
<span><span class="co">#&gt; y gaussian y ~ lag(x)</span></span>
<span><span class="co">#&gt; x poisson  x ~ z</span></span></code></pre></div>
<p>Currently, the package supports the following distributions for the observations:</p>
<ul>
<li>
<strong>Bernoulli</strong> (<code>"bernoulli"</code>) with logit link.</li>
<li>
<strong>Beta</strong> (<code>"beta"</code>) with logit link, using mean and precision parametrization.</li>
<li>
<strong>Binomial</strong> (<code>"binomial"</code>) with logit link.</li>
<li>
<strong>Categorical</strong> (<code>"categorical"</code>) with a softmax link using the first category as the reference. It is recommended to use Stan version 2.23 or higher which enables the use of the <code>categorical_logit_glm</code> function in the generated Stan code for improved computational performance. See the documentation of <code>categorical_logit_glm</code> in the Stan function reference manual (<a href="https://mc-stan.org/users/documentation/" class="external-link uri">https://mc-stan.org/users/documentation/</a>) for further information.</li>
<li>
<strong>Exponential</strong> (<code>"exponential"</code>) with log link.</li>
<li>
<strong>Gamma</strong> (<code>"gamma"</code>) with log link, using mean and shape parametrization.</li>
<li>
<strong>Gaussian</strong> (<code>"gaussian"</code>) with identity link, parameterized using mean and standard deviation.</li>
<li>
<strong>Multinomial</strong> (<code>"multinomial"</code>) with a softmax link using the first category as the reference.</li>
<li>
<strong>Multivariate</strong>Gaussian] (<code>"mvgaussian"</code>) with identity link for each dimension, parameterized using the mean vector, the standard deviation vector, and the Cholesky decomposition of the correlation matrix.</li>
<li>
<strong>Negative binomial</strong> (<code>"negbin"</code>) with log link, using mean and dispersion parametrization, with an optional known offset variable. See the documentation of the <code>NegBinomial2()</code> function in the Stan function reference manual.</li>
<li>
<strong>Ordered</strong> (<code>"cumulative"</code>) with logit or probit link for ordinal regression using cumulative parametrization for the class probabilities.</li>
<li>
<strong>Poisson</strong> (<code>"poisson"</code>) with log link, with an optional known offset variable.</li>
<li>
<strong>Student</strong> <span class="math inline">\(t\)</span> (<code>"student"</code>) with identity link, parameterized using location, scale, and degrees of freedom.</li>
</ul>
<p>There is also a special response variable type <code>"deterministic"</code> which can be used to define deterministic transformations of other variables in the model. This special channel type is explained in greater detail in Section <a href="#sec:auxiliary">4.8</a>.</p>
</div>
<div class="section level3" number="4.2">
<h3 id="sec:lags">
<span class="header-section-number">4.2</span> Lagged responses and covariates<a class="anchor" aria-label="anchor" href="#sec:lags"></a>
</h3>
<p>Models in the <strong>dynamite</strong> package have limited support for contemporaneous dependencies to avoid complex cyclic dependencies that would render the processing of missing data, subsequent predictions, and causal inference challenging or impossible. In other words, the model structure must be acyclic in a sense that there is an order of the response variables such that each response at time <span class="math inline">\(t\)</span> can be unambiguously defined in this order in terms of responses that have already been defined at time <span class="math inline">\(t\)</span> or in terms of other variables in the model at time <span class="math inline">\(t-1\)</span> as formulated in Equation <a href="#eq:factorization">(1)</a>. The acyclicity of the model implied by the model formula defined by the user is checked automatically upon construction. To demonstrate, the following formula is valid:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>but the following is not, as <code>y</code> is defined in terms of <code>x</code>, <code>x</code> is defined in terms of <code>z</code>, and <code>z</code> is defined in terms of <code>y</code>, creating a cycle from <code>y</code> to <code>y</code>. This type of model formulation produces an error due to the cyclic definition of the responses:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">x</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">z</span> <span class="op">~</span> <span class="va">y</span>, family <span class="op">=</span> <span class="st">"categorical"</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00; font-weight: bold;">Error</span><span style="font-weight: bold;"> in `join_dynamiteformulas()`:</span></span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> The model must be acyclic.</span></span></code></pre></div>
<p>On the other hand, there are no limitations concerning the dependence of response variables and their previous values or previous values of exogenous covariates, i.e., lags. In the first example of Section <a href="#sec:defining">4.1</a>, we used the syntax <code>lag(x)</code>, a shorthand for <code>lag(x, k = 1)</code>, which defines a first-order lag of the variable <code>x</code> to be used as a covariate. Higher-order lags can also be defined by adjusting the argument <code>k</code>. The argument <code>x</code> of <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag()</a></code> can either be a response variable or an exogenous covariate.</p>
<p>The model component <code><a href="../reference/lags.html">lags()</a></code> can also be used to quickly add lagged responses as covariates across multiple channels. This component adds a lagged value of each response in the model as a covariate to every channel. For example, calling</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/lags.html">lags</a></span><span class="op">(</span>k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>would add <code>lag(y, k = 1)</code> and <code>lag(x, k = 1)</code> as covariates of <code>x</code> and <code>y</code>. Therefore, the previous code would produce the same model as writing</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">y</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">y</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">x</span>, k <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>The function <code><a href="../reference/lags.html">lags()</a></code> can help to simplify the individual model formulas, especially when the model consists of many channels each containing a large number of lags. Just as with the function <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag()</a></code>, the argument <code>k</code> in <code><a href="../reference/lags.html">lags()</a></code> can be adjusted to add higher-order lags of each response to each channel, but for <code><a href="../reference/lags.html">lags()</a></code> it can also be a vector so that multiple lags can be added at once. The inclusion of lagged response variables in the model implies that some time points must be considered fixed in the estimation. The number of fixed time points in the model is equal to the highest order lag <span class="math inline">\(k\)</span> of any observed response variable in the model (defined either via <code><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag()</a></code> terms or the model component <code><a href="../reference/lags.html">lags()</a></code>). Lags of exogenous covariates do not affect the number of fixed time points, as such covariates are not modeled.</p>
</div>
<div class="section level3" number="4.3">
<h3 id="time-varying-and-time-invariant-effects">
<span class="header-section-number">4.3</span> Time-varying and time-invariant effects<a class="anchor" aria-label="anchor" href="#time-varying-and-time-invariant-effects"></a>
</h3>
<p>The <code>formula</code> argument of <code><a href="../reference/dynamiteformula.html">obs()</a></code> can also contain a special term <code>varying()</code>, which defines the time-varying part of the model equation. For example, we could write</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>to define a model equation with a time-invariant intercept, a time-invariant effect of <code>z</code>, and a time-varying effect of <code>w</code>. We also avoid defining a duplicate intercept by writing <code>-1</code> within <code>varying()</code> in order to avoid identifiability issues in the model estimation. Alternatively, we could define a time-varying intercept, in which case we would write:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">z</span> <span class="op">+</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span> <span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>The part of the formula not wrapped with <code>varying()</code> is assumed to correspond to the time-invariant part of the model, which can alternatively be defined with the special syntax <code>fixed()</code>. This means that the following lines would all produce the same model:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="fu">fixed</span><span class="op">(</span><span class="op">~</span> <span class="va">z</span><span class="op">)</span> <span class="op">+</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="fu">fixed</span><span class="op">(</span><span class="op">~</span> <span class="va">z</span><span class="op">)</span> <span class="op">+</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>The use of <code>fixed()</code> is therefore optional in the formula. If both time-varying and time-invariant intercepts are defined, the model will default to using a time-varying intercept and an appropriate warning is provided for the user:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">+</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span><span class="fl">1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Both time-constant and time-varying intercept specified:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Defaulting to time-varying intercept.</span></span>
<span><span class="co">#&gt;   Family   Formula            </span></span>
<span><span class="co">#&gt; y gaussian y ~ 1 + varying(~1)</span></span></code></pre></div>
<p>When defining time-varying effects, we also need to define how their respective regression coefficients depend on time. For this purpose, a <code><a href="../reference/splines.html">splines()</a></code> component should be added to the model formula, e.g.,</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/splines.html">splines</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<p>defines a cubic B-spline with 10 degrees of freedom for the time-varying coefficients, which corresponds to the coefficient of the variable <code>w</code> in this instance. If the model contains multiple time-varying coefficients, the same spline basis is used for all coefficients, with unique spline coefficients and their corresponding random-walk standard deviations for each coefficient. The <code><a href="../reference/splines.html">splines()</a></code> component constructs the matrix of cardinal B-splines <span class="math inline">\(B_t\)</span> using the <code>bs()</code> function of the <strong>splines</strong> package based on the degrees of freedom (<code>df</code>) and the degree of the polynomials used to construct the splines (<code>degree</code>, the default being 3 corresponding to cubic B-splines). It is also possible to switch between centered (the default) and non-centered parametrization <span class="citation">(<a href="#ref-Papaspiliopoulos2007">Papaspiliopoulos, Roberts, and Sköld 2007</a>)</span> for the spline coefficients using the <code>noncentered</code> argument of the <code><a href="../reference/splines.html">splines()</a></code> component. This can affect the sampling efficiency of Stan, depending on the model and the informativeness of the data <span class="citation">(<a href="#ref-Betancourt2013">M. J. Betancourt and Girolami 2013</a>)</span>.</p>
</div>
<div class="section level3" number="4.4">
<h3 id="group-level-random-effects">
<span class="header-section-number">4.4</span> Group-level random effects<a class="anchor" aria-label="anchor" href="#group-level-random-effects"></a>
</h3>
<p>Random effect terms of a channel for each group can be defined using the special term <code>random()</code> within the <code>formula</code> argument of <code><a href="../reference/dynamiteformula.html">obs()</a></code>, analogously to <code>varying()</code> and <code>fixed()</code>. By default, all random effects within a group and across all channels are modeled as zero-mean multivariate Gaussian. The optional model component <code><a href="../reference/random_spec.html">random_spec()</a></code> can be used to define non-correlated random effects as <code>random_spec(correlated = FALSE)</code>. In addition, as with the spline coefficients, it is possible to switch between centered and non-centered (the default) parametrization of the random effects using the <code>noncentered</code> argument of <code><a href="../reference/random_spec.html">random_spec()</a></code>.</p>
<p>For example, the following code defines a Gaussian response variable <code>x</code> with a time-invariant common effect of <code>z</code> as well as a group-specific intercept and group-specific effect of <code>z</code>.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu">random</span><span class="op">(</span><span class="op">~</span><span class="fl">1</span> <span class="op">+</span> <span class="va">z</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span></span></code></pre></div>
<p>The variable that defines the groups in the data is provided in the call to the model fitting function <code><a href="../reference/dynamite.html">dynamite()</a></code> via the <code>group</code> argument as shown in Section <a href="#sec:fitting">5</a>.</p>
</div>
<div class="section level3" number="4.5">
<h3 id="latent-factors">
<span class="header-section-number">4.5</span> Latent factors<a class="anchor" aria-label="anchor" href="#latent-factors"></a>
</h3>
<p>Instead of common time-varying intercept terms, it is possible to define channel-specific univariate latent factors using the <code><a href="../reference/lfactor.html">lfactor()</a></code> model component. Each latent factor is modeled as a spline, with degrees of freedom and spline degree defined via the <code><a href="../reference/splines.html">splines()</a></code> component (in the case that the model also contains time-varying effects, the same spline basis definition is currently used for both latent factors and time-varying effects). The argument <code>responses</code> of <code><a href="../reference/lfactor.html">lfactor()</a></code> defines which channels should contain a latent factor, while argument <code>correlated</code> determines whether the latent factors should be modeled as correlated. Again, users can switch between centered and non-centered parametrizations using the argument <code>noncentered_psi</code>.</p>
<p>In general, dynamic latent factors are not identifiable without imposing some constraints on the factor loadings <span class="math inline">\(\lambda\)</span> or the latent factor <span class="math inline">\(\psi\)</span> <span class="citation">(see e.g., <a href="#ref-bai2015">Bai and Wang 2015</a>)</span>, especially in the context of DMPMs and <strong>dynamite</strong>. In <strong>dynamite</strong>, these identifiability problems are addressed via internal reparametrization and an additional argument <code>nonzero_lambda</code> which determines whether we assume that the expected value of the factor loadings is zero or not. The theory and thorough experiments regarding the robustness of these identifiability constraints is a work in progress, so some caution should be used regarding the use of the <code><a href="../reference/lfactor.html">lfactor()</a></code> component.</p>
</div>
<div class="section level3" number="4.6">
<h3 id="sec:multivariate">
<span class="header-section-number">4.6</span> Multivariate channels<a class="anchor" aria-label="anchor" href="#sec:multivariate"></a>
</h3>
<p>While models with more than one channel are multivariate by definition, it is also possible to define individual channels whose responses follow multivariate distributions. In <code><a href="../reference/dynamiteformula.html">obs()</a></code>, a multivariate response should be given by specifying the data variables that define its dimensions and combining them with <code><a href="https://rdrr.io/r/base/c.html" class="external-link">c()</a></code>. For instance, suppose that we wish to define a multivariate Gaussian channel whose dimensions are given by variables <code>y1</code>, <code>y2</code>, and <code>y3</code> with a time-invariant effect of <code>x</code> for each dimension. Then we would write:</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">y2</span>, <span class="va">y3</span><span class="op">)</span> <span class="op">~</span> <span class="va">x</span>, family <span class="op">=</span> <span class="st">"mvgaussian"</span><span class="op">)</span></span></code></pre></div>
<p>It is also possible to define a distinct formula for each dimension by separating the dimension-specific definitions with a vertical bar <code>|</code>, for example</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">y1</span>, <span class="va">y2</span>, <span class="va">y3</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span> <span class="op">|</span> <span class="va">x</span> <span class="op">|</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">y1</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"mvgaussian"</span><span class="op">)</span></span></code></pre></div>
<p>would define no covariates for the first dimension, <code>x</code> as a covariates for the second dimension, and the lagged value of the first dimension as a covariate for the third dimension. The dimension-specific formulas can contain time-invariant and time-varying effects, group-specific random effects, and latent factors, just like univariate channel formulas can.</p>
</div>
<div class="section level3" number="4.7">
<h3 id="number-of-trials-and-offset-variables">
<span class="header-section-number">4.7</span> Number of trials and offset variables<a class="anchor" aria-label="anchor" href="#number-of-trials-and-offset-variables"></a>
</h3>
<p>The special terms <code>trials()</code> and <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> define the number of trials for binomial and multinomial channels, and an offset variable for negative binomial and Poisson channels, respectively. The arguments to these special terms can be exogenous covariates or other response variables of the model, as long as the possible contemporaneous dependencies do not violate the acyclicity of the model as described in Section <a href="#sec:lags">4.2</a>. For example, the size of a population could be used as an offset when modeling the prevalence of a disease. Modeling the population size in addition to the prevalence enables future predictions for the prevalence when the future population size is unknown.</p>
<p>Both <code>trials()</code> and <code><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset()</a></code> terms are added to the formula similar to <code>varying()</code> or <code>random()</code> terms:</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu">trials</span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"binomial"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/offset.html" class="external-link">offset</a></span><span class="op">(</span><span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span></span></code></pre></div>
<p>The code above would define a model with a binomial response <code>y</code> with a time-invariant effect of <code>z</code> and the number of trials given by the variable <code>n</code>, and a Poisson response <code>x</code> with a time-invariant effect of <code>z</code> and the variable <code>w</code> as the offset.</p>
</div>
<div class="section level3" number="4.8">
<h3 id="sec:auxiliary">
<span class="header-section-number">4.8</span> Auxiliary channels<a class="anchor" aria-label="anchor" href="#sec:auxiliary"></a>
</h3>
<p>In addition to declaring response variables via <code><a href="../reference/dynamiteformula.html">obs()</a></code>, we can also use the function <code><a href="../reference/dynamiteformula.html">aux()</a></code> to define auxiliary channels which are deterministic transformations of other variables in the model. Defining these auxiliary variables explicitly instead of defining them implicitly on the right-hand side of the formulas, i.e., by using the “as is” function <code><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I()</a></code>, makes the subsequent prediction steps clearer and allows easier checks of the model validity. Because of this, we do not allow the use of <code><a href="https://rdrr.io/r/base/AsIs.html" class="external-link">I()</a></code> in the <code>formula</code> argument of <code><a href="../reference/dynamiteformula.html">dynamiteformula()</a></code>. The values of auxiliary variables are computed automatically when fitting the model, and dynamically during prediction, making the use of lagged values and other transformations possible and automatic in prediction as well. An example of a model formula using an auxiliary channel could be</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">log1x</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">aux</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">log1x</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span><span class="op">)</span> <span class="op">|</span> <span class="fu">init</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>For auxiliary channels, the formula declaration via <code>~</code> should be understood as mathematical equality or assignment, where the right-hand side provides the defining expression of the variable on the left-hand side. Thus, the example above defines a new auxiliary channel whose response is <code>log1x</code> defined as the logarithm of <code>1 + x</code>, and assigns it to be of type <code>"numeric"</code>. The type declaration is required, because it might not be possible to unambiguously determine the type of the response variable based on its expression alone from the data, especially if the expression contains <code>"factor"</code> type variables. Supported types include <code>"factor"</code>, <code>"numeric"</code>, <code>"integer"</code>, and <code>"logical"</code>. A warning is issued to the user if the type declaration is missing from the auxiliary channel definition, and the channel will default to the <code>"numeric"</code> type:</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">aux</a></span><span class="op">(</span><span class="va">log1x</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span><span class="op">)</span> <span class="op">|</span> <span class="fu">init</span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: No type specified for deterministic channel `log1x`:</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Assuming type is <span style="color: #0000BB;">&lt;numeric&gt;</span>.</span></span>
<span><span class="co">#&gt;       Family        Formula                     </span></span>
<span><span class="co">#&gt; log1x deterministic log1x ~ log(1 + x) | init(0)</span></span></code></pre></div>
<p>Auxiliary variables can be used directly in the formulas of other channels, just like any other variable. The function <code><a href="../reference/dynamiteformula.html">aux()</a></code> does not use the <code>family</code> argument, as the <code>family</code> is automatically set to <code>"deterministic"</code> which is a special channel type of the <code><a href="../reference/dynamiteformula.html">obs()</a></code> function. Note that lagged values of deterministic auxiliary channels do not imply fixed time points. Instead, they must be given starting values using one of the two special syntax variants, <code>init()</code> or <code>past()</code> after the main formula separated by the <code>|</code> symbol.</p>
<p>In the example above, because the channel for <code>y</code> contains a lagged value of <code>log1x</code> as a covariate, we also need to supply <code>log1x</code> with a single initial value that determines the value of the lag at the first time point. Here, <code>init(0)</code> defines the initial value of <code>lag(log1x)</code> to be zero for all individuals. In general, if the model contains higher-order lags of an auxiliary channel, then <code>init()</code> can be supplied with a vector initializing each lag.</p>
<p>While <code>init()</code> defines the same starting value to be used for all individuals, an alternative, special syntax <code>past()</code> can be used, which takes an R expression as its argument and computes the starting value for each individual based on that expression. The expression is evaluated in the context of the <code>data</code> supplied to the model fitting function <code><a href="../reference/dynamite.html">dynamite()</a></code>. For example, instead of <code>init(0)</code> in the example above, we could write:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">y</span> <span class="op">~</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html" class="external-link">lag</a></span><span class="op">(</span><span class="va">log1x</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"gaussian"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="va">z</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/dynamiteformula.html">aux</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="va">log1x</span><span class="op">)</span> <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">x</span><span class="op">)</span> <span class="op">|</span> <span class="fu">past</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">z</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>which defines that the value of <code>lag(log1x)</code> at the first time point is <code>log(z)</code> for each individual, using the value of <code>z</code> in the data to be supplied to compute the actual value of the expression. The special syntax <code>past()</code> can also be used if the model contains higher-order lags of auxiliary responses. In this case, additional observations from the variables bound by the expression given as the argument will simply be used to define the initial values.</p>
</div>
<div class="section level3" number="4.9">
<h3 id="sec:modelvis">
<span class="header-section-number">4.9</span> Visualizing the model structure<a class="anchor" aria-label="anchor" href="#sec:modelvis"></a>
</h3>
<p>A <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method is available for <code>"dynamiteformula"</code> objects that can be used to easily visualize the overall model structure as a DAG. This method can produce either a <code>"ggplot"</code> object of the model plot or a <code>"character"</code> string describing a <strong>TikZ</strong> <span class="citation">(<a href="#ref-tikz">Tantau 2024</a>)</span> code to render the figure in a report, for example. As an illustration, we produce an analogous <code>"ggplot"</code> version of the DAG depicting the multichannel model that was considered in Section <a href="#sec:multichannel">3.2</a>. Figure <a href="#fig:multichanneldagplot">5</a> shows the plots obtained by running the following.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">multi_formula</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">multi_formula</span>, show_auxiliary <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:multichanneldagplot"></span>
<img src="dynamite_files/figure-html/multichanneldagplot-1.png" alt='DAGs for the multichannel model created using the `plot()` method for `"dynamitefit"` objects. The left panel shows the model structure including the auxiliary channel `logp` while the right panel shows the model structure where the auxiliary channel is not included. The latter DAG is obtained via a functional projection where the parents of `logp` become the parents of the children of `logp` and `logp` is removed from the graph at each timepoint.' width="45%"><img src="dynamite_files/figure-html/multichanneldagplot-2.png" alt='DAGs for the multichannel model created using the `plot()` method for `"dynamitefit"` objects. The left panel shows the model structure including the auxiliary channel `logp` while the right panel shows the model structure where the auxiliary channel is not included. The latter DAG is obtained via a functional projection where the parents of `logp` become the parents of the children of `logp` and `logp` is removed from the graph at each timepoint.' width="45%"><p class="caption">
Figure 5: DAGs for the multichannel model created using the <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method for <code>"dynamitefit"</code> objects. The left panel shows the model structure including the auxiliary channel <code>logp</code> while the right panel shows the model structure where the auxiliary channel is not included. The latter DAG is obtained via a functional projection where the parents of <code>logp</code> become the parents of the children of <code>logp</code> and <code>logp</code> is removed from the graph at each timepoint.
</p>
</div>
<p>Above, we used the argument <code>show_auxiliary</code> to project out the deterministic auxiliary variable <code>logp</code> from the DAG shown in the right panel of Figure <a href="#fig:multichanneldagplot">5</a>, which produces the same DAG as shown in Figure @ref(fig:multichannel_dag). In addition, the argument <code>show_covariates</code> can be used to control whether exogenous covariates should be included in the plot (the default is <code>FALSE</code> hiding covariates). Vertical, horizontal, and diagonal edges that would otherwise pass through vertices are automatically curved in the resulting figure to avoid overlapping with the vertices, but this can still occur with more complicated models.</p>
<p>As demonstrated by Figure <a href="#fig:multichanneldagplot">5</a>, mathematical notation is not always rendered ideally in <code>"ggplot"</code> figures. To generate publication-quality figures with vector graphics, the argument <code>tikz</code> is provided. By setting <code>tikz = TRUE</code>, we can obtain the corresponding <strong>TikZ</strong> code for the figure as follows:</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">multi_formula</span>, show_auxiliary <span class="op">=</span> <span class="cn">FALSE</span>, tikz <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; % Preamble</span></span>
<span><span class="co">#&gt; \usepackage{tikz}</span></span>
<span><span class="co">#&gt; \usetikzlibrary{positioning, arrows.meta, shapes.geometric}</span></span>
<span><span class="co">#&gt; \tikzset{%</span></span>
<span><span class="co">#&gt;   semithick,</span></span>
<span><span class="co">#&gt;   &gt;={Stealth[width=1.5mm,length=2mm]},</span></span>
<span><span class="co">#&gt;   obs/.style 2 args = {</span></span>
<span><span class="co">#&gt;     name = #1, circle, draw, inner sep = 8pt, label = center:$#2$</span></span>
<span><span class="co">#&gt;   }</span></span>
<span><span class="co">#&gt; }</span></span>
<span><span class="co">#&gt; % DAG</span></span>
<span><span class="co">#&gt; \begin{tikzpicture}</span></span>
<span><span class="co">#&gt;   \node [obs = {v1}{g_{t - 1}}] at (-1, 3) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v2}{p_{t - 1}}] at (-1, 2) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v3}{b_{t - 1}}] at (-1, 1) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v4}{g_{t + 1}}] at (1, 3) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v5}{p_{t + 1}}] at (1, 2) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v6}{b_{t + 1}}] at (1, 1) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v7}{g_{t}}] at (0, 3) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v8}{p_{t}}] at (0, 2) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \node [obs = {v9}{b_{t}}] at (0, 1) {\vphantom{0}};</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v1) -- (v7);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v1) -- (v8);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v3) -- (v8);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v3) -- (v9);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v1) -- (v9);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v2) -- (v7);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v2) -- (v8);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v2) -- (v9);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v7) -- (v4);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v7) -- (v5);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v9) -- (v5);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v9) -- (v6);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v7) -- (v6);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v8) -- (v4);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v8) -- (v5);</span></span>
<span><span class="co">#&gt;   \draw [-&gt;] (v8) -- (v6);</span></span>
<span><span class="co">#&gt; \end{tikzpicture}</span></span></code></pre></div>
<p>The default style used in the generated <strong>TikZ</strong> code mimics the style used in Figure <a href="#fig:multichanneldag">1</a>.</p>
</div>
</div>
<div class="section level2" number="5">
<h2 id="sec:fitting">
<span class="header-section-number">5</span> Model fitting and posterior inference<a class="anchor" aria-label="anchor" href="#sec:fitting"></a>
</h2>
<p>To estimate the model, the declared model formula is supplied to the <code><a href="../reference/dynamite.html">dynamite()</a></code> function, which has the following arguments:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamite.html">dynamite</a></span><span class="op">(</span></span>
<span>  <span class="va">dformula</span>, <span class="va">data</span>, <span class="va">time</span>, group <span class="op">=</span> <span class="cn">NULL</span>, priors <span class="op">=</span> <span class="cn">NULL</span>, backend <span class="op">=</span> <span class="st">"rstan"</span>,</span>
<span>  verbose <span class="op">=</span> <span class="cn">TRUE</span>, verbose_stan <span class="op">=</span> <span class="cn">FALSE</span>, stanc_options <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"O0"</span><span class="op">)</span>,</span>
<span>  threads_per_chain <span class="op">=</span> <span class="fl">1L</span>, grainsize <span class="op">=</span> <span class="cn">NULL</span>, custom_stan_model <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  debug <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>This function parses the model formula and the data to generate a custom Stan model, which is then compiled and used to simulate the posterior distribution of the model parameters. The first three arguments of the function are mandatory. The first argument <code>dformula</code> is a <code>"dynamiteformula"</code> object that defines the model using the model components described in Section <a href="#sec:construction">4</a>. The second argument <code>data</code> is a <code>"data.frame"</code> or a <code>"data.table"</code> object that contains the variables used in the model formula. The third argument <code>time</code> is a column name of <code>data</code> that specifies the unique time points.</p>
<p>The remaining arguments of the function are optional. The <code>group</code> argument is a column name of <code>data</code> that specifies the unique groups (individuals), and when <code>group</code> is <code>NULL</code> we assume that there is only a single group (or individual). The argument <code>priors</code> supplies user-defined priors for the model parameters. The Stan backend can be selected using the <code>backend</code> argument, which accepts either <code>"rstan"</code> (the default) or <code>"cmdstanr"</code>. These options correspond to using the <strong>rstan</strong> and <strong>cmdstanr</strong> packages for the estimation, respectively. The <code>verbose</code> and <code>verbose_stan</code> arguments control the verbosity of the output from <code><a href="../reference/dynamite.html">dynamite()</a></code> and Stan, respectively. Additional C++ compiler options such as the optimization level can be specified with <code>stanc_options</code> when using the <code>"cmdstanr"</code> backend.</p>
<p>While Stan supports between-chain parallelization via the <code>cores</code> and <code>parallel_chains</code> arguments for the <code>"rstan"</code> and <code>"cmdstanr"</code> backends, respectively, it also supports within-chain parallelization. In between-chain parallelization, the computations are split such that a single process is assigned one or more Markov-chains whereas in within-chain parallelization, the computations related to a single Markov chain are split, such as conditionally independent likelihood function evaluations. Both forms of parallelization can be leveraged via <code><a href="../reference/dynamite.html">dynamite()</a></code>. For between-chain parallelization, the <code>cores</code> and <code>parallel_chains</code> arguments can be passed directly to the backend sampling function via <code>...</code> (either <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">rstan::sampling()</a></code> or the <code><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample()</a></code> method of the <code>"CmdStanModel"</code> model object). For within-chain parallelization, threaded variants of all likelihood functions have been implemented in <strong>dynamite</strong> for the reduce-sum functionality of Stan, and the following two arguments are provided: <code>threads_per_chain</code> controls the number of threads to use per chain, and <code>grainsize</code> defines the suggested size of the partial sums (see the Stan manual for further information).</p>
<p>A custom Stan model code can be provided via <code>custom_stan_model</code>, which can be either a <code>"character"</code> string containing the model code or a path to a <code>.stan</code> file that contains the model code. Using this argument will override the automatically generated model code and it is intended for expert users only. Model customization is discussed at greater length in the related package vignette that can be accessed by writing <code><a href="../articles/dynamite_custom.html">vignette("dynamite_custom", package = "dynamite")</a></code>. The <code>debug</code> argument can be used for various debugging options (see <code><a href="../reference/dynamite.html">?dynamite</a></code> for further information on these options and other arguments of the function).</p>
<p>The <code>data</code> argument should be supplied in long format, i.e., with <span class="math inline">\(N \times T\)</span> rows in case of balanced panel data. Acceptable column types of <code>data</code> are <code>"integer"</code>, <code>"logical"</code>, <code>"double"</code>, <code>"character"</code>, objects of class <code>"factor"</code>, and objects of class <code>"ordered factor"</code>. Columns of the <code>"character"</code> type will be converted to <code>"factor"</code> columns. Beyond these standard types, any special classes such as <code>"Date"</code> whose internal storage type is one of the aforementioned types can be used, but these classes will be dropped, and the columns will be converted to their respective storage types. List columns are not supported. The <code>time</code> argument should be a <code>"numeric"</code> or a <code>"factor"</code> column of <code>data</code>. If <code>time</code> is a <code>"factor"</code> column, it will be converted to an <code>"integer"</code> column. Missing values in both response and predictor columns are supported but non-finite values are not. Observations with missing covariate or response values are omitted from the data when the model is fitted.</p>
<p>As an example, the following function call would estimate the model using data in the data frame <code>d</code>, which contains the variables <code>year</code> and <code>id</code> (defining the time-index and group-index variables of the data, respectively). Arguments <code>chains</code> and <code>cores</code> are passed to <code><a href="https://mc-stan.org/rstan/reference/stanmodel-method-sampling.html" class="external-link">rstan::sampling()</a></code> which then uses two parallel Markov chains in the MCMC sampling of the model parameters (as defined by <code>chains = 2</code> and <code>cores = 2</code>).</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/dynamite.html">dynamite</a></span><span class="op">(</span></span>
<span>  dformula <span class="op">=</span> <span class="fu"><a href="../reference/dynamiteformula.html">obs</a></span><span class="op">(</span><span class="va">x</span> <span class="op">~</span> <span class="fu">varying</span><span class="op">(</span><span class="op">~</span> <span class="op">-</span><span class="fl">1</span> <span class="op">+</span> <span class="va">w</span><span class="op">)</span>, family <span class="op">=</span> <span class="st">"poisson"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="fu"><a href="../reference/splines.html">splines</a></span><span class="op">(</span>df <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>,</span>
<span>  data <span class="op">=</span> <span class="va">d</span>, time <span class="op">=</span> <span class="st">"year"</span>, group <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  chains <span class="op">=</span> <span class="fl">2</span>, cores <span class="op">=</span> <span class="fl">2</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The output of <code><a href="../reference/dynamite.html">dynamite()</a></code> is a <code>"dynamitefit"</code> object for which the standard S3 methods such as <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code>, <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code>, <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code>, <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code>, and <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> are provided along with various other methods and utility functions which we will describe in the following sections in more detail.</p>
<div class="section level3" number="5.1">
<h3 id="user-defined-priors">
<span class="header-section-number">5.1</span> User-defined priors<a class="anchor" aria-label="anchor" href="#user-defined-priors"></a>
</h3>
<p>The function <code><a href="../reference/get_priors.html">get_priors()</a></code> can be used to determine the parameters of the model whose prior distribution can be customized. The function can be applied to an existing model fit object (<code>"dynamitefit"</code>) or a model formula object (<code>"dynamiteformula"</code>). The function returns a <code>"data.frame"</code> object, which the user can then manipulate to include their desired priors and subsequently supply to the model fitting function <code><a href="../reference/dynamite.html">dynamite()</a></code>. The rationale behind the default prior specifications is discussed in detail in the related package vignette which can be viewed by writing <code><a href="../articles/dynamite_priors.html">vignette("dynamite_priors", package = "dynamite")</a></code>.</p>
<p>For instance, using the model fit object <code>gaussian_example_fit</code> available in the <strong>dynamite</strong> package, we have the following priors:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/get_priors.html">get_priors</a></span><span class="op">(</span><span class="va">gaussian_example_fit</span><span class="op">)</span></span>
<span><span class="co">#&gt;          parameter response             prior      type category</span></span>
<span><span class="co">#&gt; 1 sigma_nu_y_alpha        y    normal(0, 3.1)  sigma_nu         </span></span>
<span><span class="co">#&gt; 2          alpha_y        y  normal(1.5, 3.1)     alpha         </span></span>
<span><span class="co">#&gt; 3      tau_alpha_y        y    normal(0, 3.1) tau_alpha         </span></span>
<span><span class="co">#&gt; 4         beta_y_z        y    normal(0, 3.1)      beta         </span></span>
<span><span class="co">#&gt; 5        delta_y_x        y    normal(0, 3.1)     delta         </span></span>
<span><span class="co">#&gt; 6   delta_y_y_lag1        y    normal(0, 1.8)     delta         </span></span>
<span><span class="co">#&gt; 7          tau_y_x        y    normal(0, 3.1)       tau         </span></span>
<span><span class="co">#&gt; 8     tau_y_y_lag1        y    normal(0, 1.8)       tau         </span></span>
<span><span class="co">#&gt; 9          sigma_y        y exponential(0.65)     sigma</span></span></code></pre></div>
<p>To customize a prior distribution, the user only needs to manipulate the <code>prior</code> column of the desired parameters in this <code>"data.frame"</code> using the appropriate Stan syntax and parametrization. For a categorical response variable, the column <code>category</code> describes which category the parameter is related to. For model parameters of the same type and response, a vectorized form of the corresponding distribution is automatically used in the generated Stan code if applicable. The definitions of the prior distributions are checked for validity before the model fitting process.</p>
</div>
<div class="section level3" number="5.2">
<h3 id="extracting-model-fit-information">
<span class="header-section-number">5.2</span> Extracting model fit information<a class="anchor" aria-label="anchor" href="#extracting-model-fit-information"></a>
</h3>
<p>We can obtain a simple model summary with the <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> method of objects of class <code>"dynamitefit"</code>. For instance, the model fit object <code>gaussian_example_fit</code> gives the following output:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">gaussian_example_fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; Model:</span></span>
<span><span class="co">#&gt;   Family   Formula                                       </span></span>
<span><span class="co">#&gt; y gaussian y ~ -1 + z + varying(~x + lag(y)) + random(~1)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Correlated random effects added for response(s): y</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Data: gaussian_example (Number of observations: 1450)</span></span>
<span><span class="co">#&gt; Grouping variable: id (Number of groups: 50)</span></span>
<span><span class="co">#&gt; Time index variable: time (Number of time points: 30)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; NUTS sampler diagnostics:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; No divergences, saturated max treedepths or low E-BFMIs.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smallest bulk-ESS: 178 (sigma_y)</span></span>
<span><span class="co">#&gt; Smallest tail-ESS: 156 (tau_alpha_y)</span></span>
<span><span class="co">#&gt; Largest Rhat: 1.018 (beta_y_z)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Elapsed time (seconds):</span></span>
<span><span class="co">#&gt;         warmup sample</span></span>
<span><span class="co">#&gt; chain:1  6.313  3.086</span></span>
<span><span class="co">#&gt; chain:2  6.472  3.322</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary statistics of the time- and group-invariant parameters:</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 10</span></span></span>
<span><span class="co">#&gt;   variable      mean median      sd     mad     q5   q95  rhat ess_bulk ess_tail</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>        <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> beta_y_z    1.97   1.97   0.011<span style="text-decoration: underline;">2</span>  0.011<span style="text-decoration: underline;">3</span>  1.95   1.98  1.02      230.     175.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> sigma_nu_y… 0.095<span style="text-decoration: underline;">5</span> 0.094<span style="text-decoration: underline;">0</span> 0.011<span style="text-decoration: underline;">7</span>  0.010<span style="text-decoration: underline;">3</span>  0.079<span style="text-decoration: underline;">1</span> 0.120 1.00      195.     157.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> sigma_y     0.198  0.198  0.004<span style="text-decoration: underline;">04</span> 0.004<span style="text-decoration: underline;">01</span> 0.192  0.205 0.995     178.     188.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> tau_alpha_y 0.200  0.193  0.046<span style="text-decoration: underline;">3</span>  0.044<span style="text-decoration: underline;">0</span>  0.139  0.283 0.999     211.     156.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> tau_y_x     0.364  0.348  0.077<span style="text-decoration: underline;">0</span>  0.074<span style="text-decoration: underline;">6</span>  0.253  0.497 1.01      198.     187.</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> tau_y_y_la… 0.105  0.102  0.020<span style="text-decoration: underline;">8</span>  0.019<span style="text-decoration: underline;">5</span>  0.076<span style="text-decoration: underline;">4</span> 0.140 1.01      231.     186.</span></span></code></pre></div>
<p>By default, the argument <code>full_diagnostics</code> of the <code><a href="https://rdrr.io/r/base/print.html" class="external-link">print()</a></code> method is set to <code>FALSE</code> which means that the model diagnostics are computed only for the time-invariant and non-group-specific parameters. Setting this argument to <code>TRUE</code> will compute the diagnostics for all model parameters which can be time-consuming for complex models. Convergence of the MCMC chains and the smallest effective sample sizes of the model parameters can be assessed using the <code><a href="../reference/mcmc_diagnostics.html">mcmc_diagnostics()</a></code> method of <code>"dynamitefit"</code> object whose arguments are the model fit object and <code>n</code>, the number of potentially problematic variables to report (default is 3). We refer the reader to <span class="citation">(<a href="#ref-vehtari2021rhat">Vehtari et al. 2021</a>)</span> and to the documentation of the <code><a href="https://mc-stan.org/rstan/reference/check_hmc_diagnostics.html" class="external-link">rstan::check_hmc_diagnostics()</a></code> and <code><a href="https://mc-stan.org/posterior/reference/draws_summary.html" class="external-link">posterior::default_convergence_measures()</a></code> functions for detailed information on the diagnostics reported by the <code><a href="../reference/mcmc_diagnostics.html">mcmc_diagnostics()</a></code> function.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/mcmc_diagnostics.html">mcmc_diagnostics</a></span><span class="op">(</span><span class="va">gaussian_example_fit</span><span class="op">)</span></span>
<span><span class="co">#&gt; NUTS sampler diagnostics:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; No divergences, saturated max treedepths or low E-BFMIs.</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smallest bulk-ESS values: </span></span>
<span><span class="co">#&gt;                       </span></span>
<span><span class="co">#&gt; nu_y_alpha_id16    106</span></span>
<span><span class="co">#&gt; alpha_y[28]        118</span></span>
<span><span class="co">#&gt; delta_y_y_lag1[14] 118</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Smallest tail-ESS values: </span></span>
<span><span class="co">#&gt;                  </span></span>
<span><span class="co">#&gt; alpha_y[7]    109</span></span>
<span><span class="co">#&gt; alpha_y[14]   111</span></span>
<span><span class="co">#&gt; delta_y_x[13] 114</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Largest Rhat values: </span></span>
<span><span class="co">#&gt;                     </span></span>
<span><span class="co">#&gt; delta_y_x[12]   1.04</span></span>
<span><span class="co">#&gt; delta_y_x[8]    1.03</span></span>
<span><span class="co">#&gt; nu_y_alpha_id39 1.03</span></span></code></pre></div>
<p>We note that due to CRAN file size restrictions, the number of stored posterior samples in this example <code>"dynamitefit"</code> object is very small, leading to small effective sample sizes. Diagnostics specific to HMC can be extracted with the <code><a href="../reference/hmc_diagnostics.html">hmc_diagnostics()</a></code> method.</p>
<p>A table of posterior draws or summaries of each parameter of the model can be obtained with the methods <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code> and <code><a href="../reference/as.data.table.dynamitefit.html">as.data.table()</a></code> which differ only by their output type (<code>"data.frame"</code> and <code>"data.table"</code>). More specifically, the output of <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code> is a tibble; a tidyverse variant of data frames of class <code>"tbl_df"</code> as defined in the <strong>tibble</strong> package <span class="citation">(<a href="#ref-tibble">Müller and Wickham 2023</a>)</span>. These two methods have the following arguments:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/as.data.frame.dynamitefit.html">as.data.frame.dynamitefit</a></span><span class="op">(</span></span>
<span>  <span class="va">x</span>, <span class="va">keep.rownames</span>, row.names <span class="op">=</span> <span class="cn">NULL</span>, optional <span class="op">=</span> <span class="cn">FALSE</span>, types <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  parameters <span class="op">=</span> <span class="cn">NULL</span>, responses <span class="op">=</span> <span class="cn">NULL</span>, times <span class="op">=</span> <span class="cn">NULL</span>, groups <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  summary <span class="op">=</span> <span class="cn">FALSE</span>, probs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.95</span><span class="op">)</span>, include_fixed <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Here, <code>x</code> is the <code>"dynamitefit"</code> object and <code>types</code> is a <code>"character"</code> vector that determines the types parameters that will be included in the output. If <code>types</code> is not used, a <code>"character"</code> vector argument <code>parameters</code> can be used to specify exactly which parameters of the model should be included. The argument <code>responses</code> can be used select parameters that are related to specific response channels. For determining suitable options for the arguments <code>types</code> and <code>parameters</code>, methods <code><a href="../reference/get_parameter_types.html">get_parameter_types()</a></code> and <code><a href="../reference/get_parameter_names.html">get_parameter_names()</a></code> can be used. The arguments <code>times</code> and <code>groups</code> can be used to further restrict the parameters in the output to only include specific time points or groups, respectively. The argument <code>summary</code> determines whether to provide summary statistics (mean, standard deviation, and quantiles selected by the argument <code>probs</code>) of each parameter, or the full posterior draws. The argument <code>include_fixed</code> determines whether to include parameters related to fixed time points in the output (see Section <a href="#sec:lags">4.2</a> for details on fixed time points). The default arguments of the methods <code>keep.rownames</code>, <code>row.names</code>, <code>optional</code>, and <code>...</code> are ignored for <code>"dynamitefit"</code> objects. All parameter types used in <strong>dynamite</strong> are described in Table <a href="#tab:dynamitetypes">2</a>.</p>
<table class="table">
<caption>
<span id="tab:dynamitetypes">Table 2: </span> The parameter types used in <strong>dynamite</strong>.</caption>
<colgroup>
<col width="17%">
<col width="82%">
</colgroup>
<thead><tr class="header">
<th>Parameter type</th>
<th>Description</th>
</tr></thead>
<tbody>
<tr class="odd">
<td><code>"alpha"</code></td>
<td>Intercept terms (time-invariant <span class="math inline">\(\alpha_{c}\)</span> or time-varying <span class="math inline">\(\alpha_{c,t}\)</span>)</td>
</tr>
<tr class="even">
<td><code>"beta"</code></td>
<td>Time-invariant regression coefficients <span class="math inline">\(\beta_c\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"corr"</code></td>
<td>Pairwise correlations of multivariate Gaussian responses</td>
</tr>
<tr class="even">
<td><code>"corr_nu"</code></td>
<td>Pairwise within-group correlations of random effects <span class="math inline">\(\nu_{c,i}\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"corr_psi"</code></td>
<td>Pairwise correlations of the latent factors <span class="math inline">\(\psi_{c,t}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"cutpoint"</code></td>
<td>Cutpoints for ordinal regression (time-invariant or time-varying)</td>
</tr>
<tr class="odd">
<td><code>"delta"</code></td>
<td>Time-varying regression coefficients <span class="math inline">\(\delta_{c,t}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"kappa"</code></td>
<td>The contribution of latent factor loadings in the total variation</td>
</tr>
<tr class="odd">
<td><code>"lambda"</code></td>
<td>Latent factor loadings <span class="math inline">\(\lambda_{c,i}\)</span> of the latent factors <span class="math inline">\(\psi_{c,t}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"nu"</code></td>
<td>Group-level random effects <span class="math inline">\(\nu_{c,i}\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"omega"</code></td>
<td>Spline coefficients <span class="math inline">\(\omega_{c,k}\)</span> of the regression coefficients <span class="math inline">\(\delta_{c,t}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"omega_alpha"</code></td>
<td>Spline coefficients of the time-varying intercepts <span class="math inline">\(\alpha_{c,t}\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"omega_psi"</code></td>
<td>Spline coefficients of the latent factors <span class="math inline">\(\psi_{c,t}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"phi"</code></td>
<td>Describes various distributional parameters, such as:</td>
</tr>
<tr class="odd">
<td></td>
<td>the dispersion parameter of the negative binomial distribution,</td>
</tr>
<tr class="even">
<td></td>
<td>the shape parameter of the gamma distribution,</td>
</tr>
<tr class="odd">
<td></td>
<td>the precision parameter of the beta distribution,</td>
</tr>
<tr class="even">
<td></td>
<td>the degrees of freedom of the Student <span class="math inline">\(t\)</span> distribution.</td>
</tr>
<tr class="odd">
<td><code>"psi"</code></td>
<td>Latent factors <span class="math inline">\(\psi_{c,t}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"sigma"</code></td>
<td>Standard deviations of (multivariate) Gaussian responses</td>
</tr>
<tr class="odd">
<td><code>"sigma_lambda"</code></td>
<td>Standard deviations of the latent factor loadings <span class="math inline">\(\lambda_{c,i}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"sigma_nu"</code></td>
<td>Standard deviations of the random effects <span class="math inline">\(\nu_{c,i}\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"tau"</code></td>
<td>Standard deviations <span class="math inline">\(\tau_{c,k}\)</span> of <span class="math inline">\(\omega_{c,k,d}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"tau_alpha"</code></td>
<td>Standard deviations of the spline coefficients of <span class="math inline">\(\alpha_{c,t}\)</span>
</td>
</tr>
<tr class="odd">
<td><code>"tau_psi"</code></td>
<td>Standard deviations of the spline coefficients of <span class="math inline">\(\psi_{c,t}\)</span>
</td>
</tr>
<tr class="even">
<td><code>"zeta"</code></td>
<td>Total variation of latent factors, i.e., <span class="math inline">\(\sigma_\lambda + \tau_\psi\)</span>
</td>
</tr>
</tbody>
</table>
<p>For instance, we can extract the posterior summary of the time-invariant regression coefficients (<code>types = "beta"</code>) for the response variable <code>y</code> in the <code>gaussian_example_fit</code> object by writing:</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame</a></span><span class="op">(</span></span>
<span>  <span class="va">gaussian_example_fit</span>,</span>
<span>  responses <span class="op">=</span> <span class="st">"y"</span>, types <span class="op">=</span> <span class="st">"beta"</span>, summary <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 1 × 10</span></span></span>
<span><span class="co">#&gt;   parameter  mean     sd    q5   q95  time group category response type </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> beta_y_z   1.97 0.011<span style="text-decoration: underline;">2</span>  1.95  1.98    <span style="color: #BB0000;">NA</span>    <span style="color: #BB0000;">NA</span> <span style="color: #BB0000;">NA</span>       y        beta</span></span></code></pre></div>
<p>For <code>"dynamitefit"</code> objects, the <code><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary()</a></code> method is a shortcut for <code>as.data.frame(summary = TRUE)</code>.</p>
<p>The generated Stan code of the model can be extracted with the method <code><a href="../reference/get_code.html">get_code()</a></code> as a <code>"character"</code> string. This feature is geared towards advanced users who may for example need to make slight modifications to the generated code in order to adapt the model to a specific scenario that cannot be accomplished with the <strong>dynamite</strong> model syntax. The generated code also contains helpful annotations describing the model blocks, parameters, and complicated code sections. Using the argument <code>blocks</code>, we can extract only specific blocks of the full model code. To illustrate, we extract the parameters block of the <code>gaussian_example_fit</code> model code as the full model code is too large to display.</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="fu"><a href="../reference/get_code.html">get_code</a></span><span class="op">(</span><span class="va">gaussian_example_fit</span>, blocks <span class="op">=</span> <span class="st">"parameters"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; parameters {</span></span>
<span><span class="co">#&gt;   // Random group-level effects</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[M] sigma_nu; // standard deviations of random effects</span></span>
<span><span class="co">#&gt;   matrix[N, M] nu_raw;</span></span>
<span><span class="co">#&gt;   vector[K_fixed_y] beta_y; // Fixed coefficients</span></span>
<span><span class="co">#&gt;   matrix[K_varying_y, D] omega_y; // Spline coefficients</span></span>
<span><span class="co">#&gt;   vector&lt;lower=0&gt;[K_varying_y] tau_y; // SDs for the random walks</span></span>
<span><span class="co">#&gt;   real a_y; // Mean of the first time point</span></span>
<span><span class="co">#&gt;   row_vector[D - 1] omega_raw_alpha_y; // Coefficients for alpha</span></span>
<span><span class="co">#&gt;   real&lt;lower=0&gt; tau_alpha_y; // SD for the random walk</span></span>
<span><span class="co">#&gt;   real&lt;lower=0&gt; sigma_y; // SD of the normal distribution</span></span>
<span><span class="co">#&gt; }</span></span></code></pre></div>
<p>Conversely, a customized Stan model code can be supplied to <code><a href="../reference/dynamite.html">dynamite()</a></code> using the <code>custom_stan_model</code> argument.</p>
</div>
<div class="section level3" number="5.3">
<h3 id="visualizing-the-posterior-distributions">
<span class="header-section-number">5.3</span> Visualizing the posterior distributions<a class="anchor" aria-label="anchor" href="#visualizing-the-posterior-distributions"></a>
</h3>
<p>The <code><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot()</a></code> method for <code>"dynamitefit"</code> objects can be used to obtain plots of various types of the model fit using the <strong>ggplot2</strong> package to produce the plots. This method has the following arguments:</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/plot.dynamitefit.html">plot.dynamitefit</a></span><span class="op">(</span></span>
<span>  <span class="va">x</span>, plot_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"default"</span>, <span class="st">"trace"</span>, <span class="st">"dag"</span><span class="op">)</span>, types <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  parameters <span class="op">=</span> <span class="cn">NULL</span>, responses <span class="op">=</span> <span class="cn">NULL</span>, groups <span class="op">=</span> <span class="cn">NULL</span>, times <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  level <span class="op">=</span> <span class="fl">0.05</span>, alpha <span class="op">=</span> <span class="fl">0.5</span>, facet <span class="op">=</span> <span class="cn">TRUE</span>, scales <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"fixed"</span>, <span class="st">"free"</span><span class="op">)</span>,</span>
<span>  n_params <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>The arguments <code>type</code>, <code>parameters</code>, <code>responses</code>, <code>groups</code> and <code>times</code> are analogous to those of the <code><a href="https://rdrr.io/r/base/as.data.frame.html" class="external-link">as.data.frame()</a></code> method for selecting which parameters should be plotted.
Arguments <code>level</code>, <code>alpha</code>, <code>facet</code> and <code>scales</code> control the visual aspects of the plot: <code>level</code> defines the plotted posterior intervals as <code>100 * (1 - 2 * level)</code> % intervals, <code>alpha</code> is the opacity level for <code><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html" class="external-link">ggplot2::geom_ribbon()</a></code> for plotting posterior intervals, <code>facet</code> determines whether time-invariant parameters should be plotted together (<code>FALSE</code>) or separately using <code><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">ggplot2::facet_wrap()</a></code> (<code>TRUE</code>), and <code>scales</code> selects whether the vertical axis of different parameters should be the same (<code>"fixed"</code>) or allowed to vary between parameters (<code>"free"</code>). Finally, <code>n_params</code> controls the maximum number of parameters of each type to plot. By default, the number of parameters is limited to prevent accidental plots with a large number of parameters that may take an excessively long time to render. Next, we showcase some example plots and the different plot types that are available via the <code>plot_type</code> argument.</p>
<p>For instance, Figure <a href="#fig:parameterposteriorplot">6</a> shows the posterior means and posterior intervals of the time-varying intercept (type <code>"alpha"</code>) and time-varying regression coefficients (type <code>"delta"</code>) in the <code>gaussian_example_fit</code> model (using the <code>"default"</code> option of the <code>plot_type</code> argument by default).</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span></span>
<span>  <span class="va">gaussian_example_fit</span>,</span>
<span>  types <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"alpha"</span>, <span class="st">"delta"</span><span class="op">)</span>, scales <span class="op">=</span> <span class="st">"free"</span></span>
<span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">""</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:parameterposteriorplot"></span>
<img src="dynamite_files/figure-html/parameterposteriorplot-1.png" alt="Posterior means (black lines) and 90\% posterior intervals (gray areas) for the time-varying coefficients for the response variable `y` in the `gaussian_example_fit` model. The panels from left to right show the time-varying intercept for `y`, the time-varying effect of `x` on `y`, and the time-varying effect of `lag(y)` (the previous time-point) on `y`." width="100%"><p class="caption">
Figure 6: Posterior means (black lines) and 90% posterior intervals (gray areas) for the time-varying coefficients for the response variable <code>y</code> in the <code>gaussian_example_fit</code> model. The panels from left to right show the time-varying intercept for <code>y</code>, the time-varying effect of <code>x</code> on <code>y</code>, and the time-varying effect of <code>lag(y)</code> (the previous time-point) on <code>y</code>.
</p>
</div>
<p>While <code>plot_type = "default"</code> produces plots such as Figure @ref(fig:parameter_posterior_plot), using <code>plot_type = "trace"</code> instead provides the marginal posterior densities and traceplots of the MCMC chains, as shown in Figure @ref(fig:gaussian_trace) where we also select the time-invariant regression coefficients of the model to be plotted.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">gaussian_example_fit</span>, plot_type <span class="op">=</span> <span class="st">"trace"</span>, types <span class="op">=</span> <span class="st">"beta"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:gaussiantrace"></span>
<img src="dynamite_files/figure-html/gaussiantrace-1.png" alt="Marginal posterior density and traceplot of the MCMC chains of the time-invariant regression coefficient `beta_y_z` of `z` for the response variable `y` in the `gaussian_example_fit` model." width="100%"><p class="caption">
Figure 7: Marginal posterior density and traceplot of the MCMC chains of the time-invariant regression coefficient <code>beta_y_z</code> of <code>z</code> for the response variable <code>y</code> in the <code>gaussian_example_fit</code> model.
</p>
</div>
<p>The third option <code>plot_type = "dag"</code> can be used to visualize the structure of the model as a DAG as shown in Figure <a href="#fig:multichanneldagplot">5</a> and described in Section <a href="#sec:modelvis">4.9</a>.</p>
</div>
<div class="section level3" number="5.4">
<h3 id="missing-data-and-multiple-imputation">
<span class="header-section-number">5.4</span> Missing data and multiple imputation<a class="anchor" aria-label="anchor" href="#missing-data-and-multiple-imputation"></a>
</h3>
<p>Panel data often contains missing observations for various reasons. A common approach in a Bayesian setting is to treat missing observations as additional unknown parameters, and to sample them along with the model parameters during MCMC. However, the MCMC sampling in <strong>dynamite</strong> is based on Stan’s variant of the gradient-based NUTS algorithm <span class="citation">(<a href="#ref-hoffman2014">Hoffman and Gelman 2014</a>; <a href="#ref-betancourt2018">M. Betancourt 2018</a>)</span>, which cannot be used to sample discrete variables such as missing count data. Therefore, the default behavior in <strong>dynamite</strong> is to use a complete-case approach which is unbiased when data are missing completely at random as well as in certain other specific settings <span class="citation">(<a href="#ref-vanBuuren2018">van Buuren 2018</a>)</span>. As an alternative to complete-case analysis with <code><a href="../reference/dynamite.html">dynamite()</a></code>, the function <code><a href="../reference/dynamice.html">dynamice()</a></code> first performs multiple imputation using the imputation algorithms of the <strong>mice</strong> package <span class="citation">(<a href="#ref-vanBuuren2011">van Buuren and Groothuis-Oudshoorn 2011</a>)</span>, runs MCMC on each imputed sample, and combines the posterior samples of each run, as suggested for example in <span class="citation">(<a href="#ref-bdabook">Gelman et al. 2013</a>)</span>.</p>
<p>The <code><a href="../reference/dynamice.html">dynamice()</a></code> function has all of the arguments of <code><a href="../reference/dynamite.html">dynamite()</a></code> with some additions. The argument <code>mice_args</code> is a <code>"list"</code> that can be used to provide arguments to the underlying imputation function <code>mice()</code> of the <strong>mice</strong> package. Format of the data during imputation can be selected with the <code>impute_format</code> argument that accepts either <code>"wide"</code> or <code>"long"</code>. Data in wide format will have one group per row (with observations at different time points in different columns) while data in long format corresponds to the standard data format of <code><a href="../reference/dynamite.html">dynamite()</a></code> described in Section <a href="#sec:fitting">5</a>. Argument <code>keep_imputed</code> is a <code>"logical"</code> value can be used to select whether the imputed data sets should be included in the return object of <code><a href="../reference/dynamice.html">dynamice()</a></code>. If <code>TRUE</code>, the imputed data sets will be found in the <code>imputed</code> field of the returned <code>"dynamitefit"</code> object. All of the methods for <code>"dynamitefit"</code> objects are available also for model fits obtained from <code><a href="../reference/dynamice.html">dynamice()</a></code>, but it should be noted that convergence measures and effective samples sizes such as those reported by <code><a href="../reference/mcmc_diagnostics.html">mcmc_diagnostics()</a></code> may be unreliable for such model fits.</p>
</div>
</div>
<div class="section level2" number="6">
<h2 id="sec:prediction">
<span class="header-section-number">6</span> Prediction<a class="anchor" aria-label="anchor" href="#sec:prediction"></a>
</h2>
<p>The <strong>dynamite</strong> package provides a comprehensive set of features for obtaining predictions based on the posterior distribution of the model parameters. The package supports the imputation of missing exogenous covariate values (via last observation carried forward or next observation carried backward), aggregated and individual-level predictions, and various methods to account for new levels of the <code>group</code> variable for random effects. Counterfactual predictions can also be obtained which enables the study of causal effects and other intricate causal quantities. It should be noted that the predictions do not directly support forecasting as there is no unambiguous way to define how the splines for the time-varying regression coefficients should behave outside of the observed time points. However, such predictions can be obtained by augmenting the original data with missing values for future time points. Furthermore, the package can be used to generate data from a DMPM without an existing model fit by first specifying the values of the model parameters and the fixed covariates (see the package vignette on data simulation for further information: <code><a href="../articles/dynamite_simulation.html">vignette("dynamite_simulation", package = "dynamite")</a></code>).</p>
<p>The <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> method for <code>"dynamitefit"</code> objects can be used to obtain predictions from the posterior predictive distribution. This function has the following arguments:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/predict.dynamitefit.html">predict.dynamitefit</a></span><span class="op">(</span></span>
<span>  <span class="va">object</span>, newdata <span class="op">=</span> <span class="cn">NULL</span>, type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"response"</span>, <span class="st">"mean"</span>, <span class="st">"link"</span><span class="op">)</span>,</span>
<span>  funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>, impute <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"locf"</span>, <span class="st">"nocb"</span><span class="op">)</span>,</span>
<span>  new_levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"none"</span>, <span class="st">"bootstrap"</span>, <span class="st">"gaussian"</span>, <span class="st">"original"</span><span class="op">)</span>,</span>
<span>  global_fixed <span class="op">=</span> <span class="cn">FALSE</span>, n_draws <span class="op">=</span> <span class="cn">NULL</span>, thin <span class="op">=</span> <span class="fl">1</span>,</span>
<span>  expand <span class="op">=</span> <span class="cn">TRUE</span>, df <span class="op">=</span> <span class="cn">TRUE</span>, <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>We will only explain the most important arguments of this method and refer the reader to the package documentation for more information. The first argument <code>object</code> is the <code>"dynamitefit"</code> object that the predictions will be based on. The argument <code>newdata</code> can be used to define the groups, time points, and covariate values that the predictions should be computed for. If <code>newdata</code> is <code>NULL</code>, predictions will be computed for the original <code>data</code> supplied to the <code><a href="../reference/dynamite.html">dynamite()</a></code> function when the model was fitted from the first non-fixed time point onward. The <code>type</code> argument selects the type of computed predictions. By default, <code>type = "response"</code> returns the individual-level simulated predictions for the response variables of the model. Options <code>"link"</code> and <code>"mean"</code> return the linear predictor values and the expected values of the posterior predictive distribution, respectively. The argument <code>n_draws</code> controls the number of posterior draws to be used for prediction. By default, all draws are used. Alternatively, the argument <code>thin</code> can be used to select every <code>thin</code>th posterior draw to be used for the prediction task.</p>
<p>For example, we can obtain posterior predictive samples for the first 4 groups in the <code>gaussian_example</code> dataset using the corresponding model fit object <code>gaussian_example_fit</code> with the first 50 posterior draws. The predictions are shown in Figure <a href="#fig:gaussianpred">8</a> and can be obtained as follows:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">gaussian_example_fit</span>, n_draws <span class="op">=</span> <span class="fl">50</span><span class="op">)</span></span>
<span><span class="va">pred</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">id</span> <span class="op">&lt;</span> <span class="fl">5</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">y_new</span>, group <span class="op">=</span> <span class="va">.draw</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>alpha <span class="op">=</span> <span class="fl">0.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"tomato"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span> <span class="va">id</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<span style="display:block;" id="fig:gaussianpred"></span>
<img src="dynamite_files/figure-html/gaussianpred-1.png" alt="Posterior predictive samples for the first 4 groups of the `gaussian_example` data. Lines in red represent the observed values." width="100%"><p class="caption">
Figure 8: Posterior predictive samples for the first 4 groups of the <code>gaussian_example</code> data. Lines in red represent the observed values.
</p>
</div>
<p>The <code><a href="https://rdrr.io/r/stats/fitted.values.html" class="external-link">fitted()</a></code> method is also provided for <code>"dynamitefit"</code> objects. In contrast to multi-step predictions of <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code>, this function computes expected values of the posterior predictive distributions at each time point conditional on the original observations.</p>
<p>We note that the multi-step predictions contain not only the parameter uncertainty but also the inherent aleatoric (stochastic) uncertainty of the trajectories. The Monte Carlo variation due to the finite number of posterior samples can be reduced by increasing the number of iterations or chains of the MCMC run (as with any posterior summaries) or by combining samples from multiple <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> calls in case the Monte Carlo error is mostly due to the trajectory simulation.</p>
<div class="section level3" number="6.1">
<h3 id="aggregated-predictions-and-memory-conservation">
<span class="header-section-number">6.1</span> Aggregated predictions and memory conservation<a class="anchor" aria-label="anchor" href="#aggregated-predictions-and-memory-conservation"></a>
</h3>
<p>For large datasets and complicated models, obtaining individual-level predictions can be memory-intensive. For example, data with 100 groups, 100 time points, a categorical response with 4 categories, and 1000 posterior draws would result in 40 million elements. A simple way to reduce memory usage is to set the argument <code>expand</code> of <code><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict()</a></code> to <code>FALSE</code> (the default is <code>TRUE</code>). Disabling this argument separates the simulated values from the fixed covariates in the model into two <code>"data.table"</code> objects in the output, called <code>simulated</code> and <code>observed</code>, which are then returned as a <code>"list"</code> object. This optimization is always carried out internally, meaning that the value of the <code>expand</code> argument only affects the returned output.</p>
<p>To further reduce memory usage, the argument <code>funs</code> can be used to obtain aggregated predictions instead of the full individual-level predictions for each time point. This argument accepts a named list of lists of named functions for each response channel of the model, where the supplied functions are then applied over the individuals. The resulting columns in the output are named based on the function names and the response variables. The <code>expand</code> argument is automatically set to <code>FALSE</code> when using the <code>funs</code> argument. For example, we could compute the mean and standard deviation of the predictions for the response variable <code>y</code> in the <code>gaussian_example</code> dataset at each time point as follows:</p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_funs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">gaussian_example_fit</span>,</span>
<span>  funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred_funs</span><span class="op">$</span><span class="va">simulated</span><span class="op">)</span></span>
<span><span class="co">#&gt;     mean_y      sd_y time .draw</span></span>
<span><span class="co">#&gt; 1       NA        NA    1     1</span></span>
<span><span class="co">#&gt; 2 1.504474 0.8527229    2     1</span></span>
<span><span class="co">#&gt; 3 1.705757 1.3061120    3     1</span></span>
<span><span class="co">#&gt; 4 1.722222 1.2155877    4     1</span></span>
<span><span class="co">#&gt; 5 2.121926 1.2646230    5     1</span></span>
<span><span class="co">#&gt; 6 2.186567 1.3738596    6     1</span></span></code></pre></div>
<p>The reduction in memory usage compared to the full individual-level predictions is rather substantial even in this simple scenario:</p>
<div class="sourceCode" id="cb56"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/hadley/pryr" class="external-link">"pryr"</a></span><span class="op">)</span></span>
<span><span class="va">pred_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">gaussian_example_fit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/object_size.html" class="external-link">object_size</a></span><span class="op">(</span><span class="va">pred_full</span><span class="op">)</span></span>
<span><span class="co">#&gt; 12.00 MB</span></span>
<span><span class="fu"><a href="https://rdrr.io/pkg/pryr/man/object_size.html" class="external-link">object_size</a></span><span class="op">(</span><span class="va">pred_funs</span><span class="op">)</span></span>
<span><span class="co">#&gt; 188.34 kB</span></span></code></pre></div>
<p>The <code>funs</code> argument can also be used to aggregate the expected values of the posterior predictive distribution with <code>type = "mean"</code>:</p>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pred_funs_mean</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span></span>
<span>  <span class="va">gaussian_example_fit</span>,</span>
<span>  type <span class="op">=</span> <span class="st">"mean"</span>,</span>
<span>  funs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>mean <span class="op">=</span> <span class="va">mean</span>, sd <span class="op">=</span> <span class="va">sd</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">pred_funs_mean</span><span class="op">$</span><span class="va">simulated</span><span class="op">)</span></span>
<span><span class="co">#&gt;     mean_y      sd_y time .draw</span></span>
<span><span class="co">#&gt; 1       NA        NA    1     1</span></span>
<span><span class="co">#&gt; 2 1.512491 0.8425512    2     1</span></span>
<span><span class="co">#&gt; 3 1.720646 1.3097006    3     1</span></span>
<span><span class="co">#&gt; 4 1.719707 1.1955273    4     1</span></span>
<span><span class="co">#&gt; 5 2.099282 1.2462898    5     1</span></span>
<span><span class="co">#&gt; 6 2.187195 1.3636075    6     1</span></span></code></pre></div>
</div>
</div>
<div class="section level2" number="7">
<h2 id="sec:summary">
<span class="header-section-number">7</span> Summary<a class="anchor" aria-label="anchor" href="#sec:summary"></a>
</h2>
<p>In this vignette, we presented the <strong>dynamite</strong> package for Bayesian inference of DMPMs. The package provides a user-friendly interface for model construction, estimation, prediction, posterior inference, and visualization with extensive and detailed documentation of its features. The package has been designed to be as general as possible by supporting multivariate models, many response variable distributions, custom prior distributions, and common model features such as time-varying effects and group-specific random effects. The package design also aims for high performance in model estimation by employing Stan and in general-purpose data manipulation by using <strong>data.table</strong> which is especially reflected in prediction. For advanced users, the Stan code generated by <strong>dynamite</strong> can be extracted and adapted to user-specific scenarios.</p>
<p>In the future, we plan to extend the capabilities of <strong>dynamite</strong> by adding support for more distributions. Some distributions in Stan also lack efficient likelihood function variants, such as the Bernoulli distribution, which will likely become available in the future and will be subsequently implemented in <strong>dynamite</strong> as well.</p>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Allison2009" class="csl-entry">
Allison, Paul D. 2009. <em>Fixed Effects Regression Models</em>. SAGE Publications. <a href="https://doi.org/10.4135/9781412993869" class="external-link">https://doi.org/10.4135/9781412993869</a>.
</div>
<div id="ref-Allison2017" class="csl-entry">
Allison, Paul D., Richard Williams, and Enrique Moral-Benito. 2017. <span>“Maximum Likelihood for Cross-Lagged Panel Models with Fixed Effects.”</span> <em>Socius</em> 3. <a href="https://doi.org/10.1177/2378023117710578" class="external-link">https://doi.org/10.1177/2378023117710578</a>.
</div>
<div id="ref-arellano1991" class="csl-entry">
Arellano, Manuel, and Stephen Bond. 1991. <span>“Some Tests of Specification for Panel Data: Monte Carlo Evidence and an Application to Employment Equations.”</span> <em>The Review of Economic Studies</em> 58 (2): 277–97. <a href="https://doi.org/10.2307/2297968" class="external-link">https://doi.org/10.2307/2297968</a>.
</div>
<div id="ref-Asparouhov2018" class="csl-entry">
Asparouhov, Tihomir, Ellen L. Hamaker, and Bengt Muthén. 2018. <span>“Dynamic Structural Equation Models.”</span> <em>Structural Equation Modeling: A Multidisciplinary Journal</em> 25 (3): 359–88. <a href="https://doi.org/10.1080/10705511.2017.1406803" class="external-link">https://doi.org/10.1080/10705511.2017.1406803</a>.
</div>
<div id="ref-bai2015" class="csl-entry">
Bai, Jushan, and Peng Wang. 2015. <span>“Identification and <span>B</span>ayesian Estimation of Dynamic Factor Models.”</span> <em>Journal of Business &amp; Economic Statistics</em> 33 (2): 221–40. <a href="https://doi.org/10.1080/07350015.2014.941467" class="external-link">https://doi.org/10.1080/07350015.2014.941467</a>.
</div>
<div id="ref-datatable" class="csl-entry">
Barrett, Tyson, Matt Dowle, Arun Srinivasan, Jan Gorecki, Michael Chirico, and Toby Hocking. 2024. <em><span class="nocase">data.table</span>: Extension of ‘Data.frame‘</em>. <a href="https://CRAN.R-project.org/package=data.table" class="external-link">https://CRAN.R-project.org/package=data.table</a>.
</div>
<div id="ref-lme4" class="csl-entry">
Bates, Douglas, Martin Mächler, Ben Bolker, and Steve Walker. 2015. <span>“Fitting Linear Mixed-Effects Models Using <span class="nocase">lme4</span>.”</span> <em>Journal of Statistical Software</em> 67 (1): 1–48. <a href="https://doi.org/10.18637/jss.v067.i01" class="external-link">https://doi.org/10.18637/jss.v067.i01</a>.
</div>
<div id="ref-fixest" class="csl-entry">
Bergé, Laurent. 2018. <span>“Efficient Estimation of Maximum Likelihood Models with Multiple Fixed-Effects: The <span>R</span> Package <span>FENmlm</span>.”</span> <em>CREA Discussion Papers</em>, no. 13.
</div>
<div id="ref-Betancourt2013" class="csl-entry">
Betancourt, M. J., and Mark Girolami. 2013. <span>“<span>H</span>amiltonian <span>M</span>onte <span>C</span>arlo for Hierarchical Models.”</span> <a href="https://doi.org/10.48550/arXiv.1312.0906" class="external-link">https://doi.org/10.48550/arXiv.1312.0906</a>.
</div>
<div id="ref-betancourt2018" class="csl-entry">
Betancourt, Michael. 2018. <span>“A Conceptual Introduction to <span>H</span>amiltonian <span>M</span>onte <span>C</span>arlo.”</span> <a href="https://doi.org/10.48550/arXiv.1701.02434" class="external-link">https://doi.org/10.48550/arXiv.1701.02434</a>.
</div>
<div id="ref-Bollen2010" class="csl-entry">
Bollen, Kenneth A., and Jennie E. Brand. 2010. <span>“A General Panel Model with Random and Fixed Effects: A Structural Equations Approach.”</span> <em>Social Forces</em> 89 (1): 1–34. <a href="https://doi.org/10.1353/sof.2010.0072" class="external-link">https://doi.org/10.1353/sof.2010.0072</a>.
</div>
<div id="ref-brodersen2014" class="csl-entry">
Brodersen, Kay H., Fabian Gallusser, Jim Koehler, Nicolas Remy, and Steven L. Scott. 2014. <span>“Inferring Causal Impact Using <span>B</span>ayesian Structural Time-Series Models.”</span> <em>The Annals of Applied Statistics</em> 9 (1): 247–74. <a href="https://doi.org/10.1214/14-AOAS788" class="external-link">https://doi.org/10.1214/14-AOAS788</a>.
</div>
<div id="ref-brms" class="csl-entry">
Bürkner, Paul-Christian. 2018. <span>“Advanced <span>Bayesian</span> Multilevel Modeling with the <span>R</span> Package <span class="nocase">brms</span>.”</span> <em>The <span>R</span> Journal</em> 10 (1): 395–411. <a href="https://doi.org/10.32614/RJ-2018-017" class="external-link">https://doi.org/10.32614/RJ-2018-017</a>.
</div>
<div id="ref-posterior" class="csl-entry">
Bürkner, Paul-Christian, Jonah Gabry, Matthew Kay, and Aki Vehtari. 2023. <em><span class="nocase">posterior</span>: Tools for Working with Posterior Distributions</em>. <a href="https://mc-stan.org/posterior/" class="external-link">https://mc-stan.org/posterior/</a>.
</div>
<div id="ref-casas2022" class="csl-entry">
Casas, Isabel, and Rubén Fernández-Casal. 2022. <span>“<span class="nocase">tvReg</span>: Time-Varying Coefficients in Multi-Equation Regression in <span>R</span>.”</span> <em>The <span>R</span> Journal</em> 14: 79–100. <a href="https://doi.org/10.32614/RJ-2022-002" class="external-link">https://doi.org/10.32614/RJ-2022-002</a>.
</div>
<div id="ref-Chow2010" class="csl-entry">
Chow, Sy-Miin, Moon-ho Ringo Ho, Ellen L. Hamaker, and Conor V. Dolan. 2010. <span>“Equivalence and Differences Between Structural Equation Modeling and State-Space Modeling Techniques.”</span> <em>Structural Equation Modeling: A Multidisciplinary Journal</em> 17: 303–32. <a href="https://doi.org/10.1080/10705511003661553" class="external-link">https://doi.org/10.1080/10705511003661553</a>.
</div>
<div id="ref-Cohen2003" class="csl-entry">
Cohen, Alma, and Liran Einav. 2003. <span>“The Effects of Mandatory Seat Belt Laws on Driving Behavior and Traffic Fatalities.”</span> <em>Review of Economics and Statistics</em> 85 (4): 828–43. <a href="https://doi.org/10.2139/ssrn.293582" class="external-link">https://doi.org/10.2139/ssrn.293582</a>.
</div>
<div id="ref-plm" class="csl-entry">
Croissant, Yves, and Giovanni Millo. 2008. <span>“Panel Data Econometrics in <span>R</span>: The <span class="nocase">plm</span> Package.”</span> <em>Journal of Statistical Software</em> 27 (2): 1–43. <a href="https://doi.org/10.18637/jss.v027.i02" class="external-link">https://doi.org/10.18637/jss.v027.i02</a>.
</div>
<div id="ref-pder" class="csl-entry">
———. 2022. <em><span class="nocase">pder</span>: Panel Data Econometrics with <span>R</span></em>. <a href="https://CRAN.R-project.org/package=pder" class="external-link">https://CRAN.R-project.org/package=pder</a>.
</div>
<div id="ref-durbin2012" class="csl-entry">
Durbin, James, and Siem Jan Koopman. 2012. <em>Time Series Analysis by State Space Methods</em>. 2nd ed. New York: Oxford University Press.
</div>
<div id="ref-dziak2021" class="csl-entry">
Dziak, John J., Donna L. Coffman, Runze Li, Kaylee Litson, and Yajnaseni Chakraborti. 2021. <em><span class="nocase">tvem</span>: Time-Varying Effect Models</em>. <a href="https://CRAN.R-project.org/package=tvem" class="external-link">https://CRAN.R-project.org/package=tvem</a>.
</div>
<div id="ref-eubank2004" class="csl-entry">
Eubank, R. L., Chunfeng Huang, Y. Muñoz Maldonado, Naisyin Wang, Suojin Wang, and R. J. Buchanan. 2004. <span>“Smoothing Spline Estimation in Varying-Coefficient Models.”</span> <em>Journal of the Royal Statistical Society B</em> 66 (3): 653–67.
</div>
<div id="ref-cmdstanr" class="csl-entry">
Gabry, Jonah, and Rok Češnovar. 2023. <em><span class="nocase">cmdstanr</span>: <span>R</span> Interface to <span>CmdStan</span></em>.
</div>
<div id="ref-bdabook" class="csl-entry">
Gelman, Andrew, John B. Carlin, Hal S. Stern, and Donald B. Rubin. 2013. <em><span>B</span>ayesian Data Analysis</em>. 3rd ed. Chapman; Hall/CRC.
</div>
<div id="ref-geepack" class="csl-entry">
Halekoh, Ulrich, Søren Højsgaard, and Jun Yan. 2006. <span>“The <span>R</span> Package <span class="nocase">geepack</span> for Generalized Estimating Equations.”</span> <em>Journal of Statistical Software</em> 15/2: 1–11. <a href="https://doi.org/10.18637/jss.v015.i02" class="external-link">https://doi.org/10.18637/jss.v015.i02</a>.
</div>
<div id="ref-Hamaker2015" class="csl-entry">
Hamaker, Ellen L, Rebecca M Kuiper, and Raoul PPP Grasman. 2015. <span>“A Critique of the Cross-Lagged Panel Model.”</span> <em>Psychological Methods</em> 20 (1): 102. <a href="https://doi.org/10.1037/a0038889" class="external-link">https://doi.org/10.1037/a0038889</a>.
</div>
<div id="ref-harvey1982" class="csl-entry">
Harvey, A. C., and G. D. A. Phillips. 1982. <span>“The Estimation of Regression Models with Time-Varying Parameters.”</span> In <em>Games, Economic Dynamics, and Time Series Analysis</em>, edited by M. Deistler, E. Fürst, and G. Schwödiauer, 306–21. Physica, Heidelberg. <a href="https://doi.org/10.1007/978-3-662-41533-7_18" class="external-link">https://doi.org/10.1007/978-3-662-41533-7_18</a>.
</div>
<div id="ref-hastie1993" class="csl-entry">
Hastie, Trevor, and Robert Tibshirani. 1993. <span>“Varying-Coefficient Models.”</span> <em>Journal of the Royal Statistical Society B</em> 55 (4): 757–96. <a href="https://doi.org/10.1111/j.2517-6161.1993.tb01939.x" class="external-link">https://doi.org/10.1111/j.2517-6161.1993.tb01939.x</a>.
</div>
<div id="ref-hayakawa2019" class="csl-entry">
Hayakawa, Kazuhiko, and Jie Hou. 2019. <span>“Estimation of Time-Varying Coefficient Dynamic Panel Data Models.”</span> <em>Communications in Statistics - Theory and Methods</em> 48 (13): 3311–24. <a href="https://doi.org/10.1080/03610926.2018.1476704" class="external-link">https://doi.org/10.1080/03610926.2018.1476704</a>.
</div>
<div id="ref-KFAS" class="csl-entry">
Helske, Jouni. 2017. <span>“<span>KFAS</span>: Exponential Family State Space Models in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 78 (10): 1–39. <a href="https://doi.org/10.18637/jss.v078.i10" class="external-link">https://doi.org/10.18637/jss.v078.i10</a>.
</div>
<div id="ref-helske2022" class="csl-entry">
———. 2022. <span>“Efficient <span>B</span>ayesian Generalized Linear Models with Time-Varying Coefficients: The <span class="nocase">walker</span> Package in <span>R</span>.”</span> <em>SoftwareX</em> 18: 101016. <a href="https://doi.org/10.1016/j.softx.2022.101016" class="external-link">https://doi.org/10.1016/j.softx.2022.101016</a>.
</div>
<div id="ref-dmpm" class="csl-entry">
Helske, Jouni, and Santtu Tikka. 2024. <span>“Estimating Causal Effects from Panel Data with Dynamic Multivariate Panel Models.”</span> <em>Advances in Life Course Research</em> 60: 100617. https://doi.org/<a href="https://doi.org/10.1016/j.alcr.2024.100617" class="external-link">https://doi.org/10.1016/j.alcr.2024.100617</a>.
</div>
<div id="ref-bssm" class="csl-entry">
Helske, Jouni, and Matti Vihola. 2021. <span>“<span class="nocase">bssm</span>: Bayesian Inference of Non-Linear and Non-Gaussian State Space Models in <span>R</span>.”</span> <em>The <span>R</span> Journal</em> 13 (2): 578–89. <a href="https://doi.org/10.32614/RJ-2021-103" class="external-link">https://doi.org/10.32614/RJ-2021-103</a>.
</div>
<div id="ref-hoffman2014" class="csl-entry">
Hoffman, Matthew D, and Andrew Gelman. 2014. <span>“The <span>No-U-Turn</span> Sampler: Adaptively Setting Path Lengths in <span>H</span>amiltonian <span>M</span>onte <span>C</span>arlo.”</span> <em>Journal of Machine Learning Research</em> 15 (47): 1593–623. <a href="http://jmlr.org/papers/v15/hoffman14a.html" class="external-link">http://jmlr.org/papers/v15/hoffman14a.html</a>.
</div>
<div id="ref-pomp" class="csl-entry">
King, Aaron A., Dao Nguyen, and Edward L. Ionides. 2016. <span>“Statistical Inference for Partially Observed <span>Markov</span> Processes via the <span>R</span> Package <span class="nocase">pomp</span>.”</span> <em>Journal of Statistical Software</em> 69 (12): 1–43. <a href="https://doi.org/10.18637/jss.v069.i12" class="external-link">https://doi.org/10.18637/jss.v069.i12</a>.
</div>
<div id="ref-knaus2021" class="csl-entry">
Knaus, Peter, Angela Bitto-Nemling, Annalisa Cadonna, and Sylvia Frühwirth-Schnatter. 2021. <span>“Shrinkage in the Time-Varying Parameter Model Framework Using the <span>R</span> Package <span class="nocase">shrinkTVP</span>.”</span> <em>Journal of Statistical Software</em> 100: 1–32. <a href="https://doi.org/10.18637/jss.v100.i13" class="external-link">https://doi.org/10.18637/jss.v100.i13</a>.
</div>
<div id="ref-lang2004" class="csl-entry">
Lang, Stefan, and Andreas Brezger. 2004. <span>“<span>B</span>ayesian <span>P</span>-Splines.”</span> <em>Journal of Computational and Graphical Statistics</em> 13 (1): 183–212. <a href="https://doi.org/10.1198/1061860043010" class="external-link">https://doi.org/10.1198/1061860043010</a>.
</div>
<div id="ref-panelr" class="csl-entry">
Long, Jacob A. 2020. <em><span class="nocase">panelr</span>: Regression Models and Utilities for Repeated Measures and Panel Data</em>. <a href="https://cran.r-project.org/package=panelr" class="external-link">https://cran.r-project.org/package=panelr</a>.
</div>
<div id="ref-Mulder2021" class="csl-entry">
Mulder, Jeroen D., and Ellen L. Hamaker. 2021. <span>“Three Extensions of the Random Intercept Cross-Lagged Panel Model.”</span> <em>Structural Equation Modeling: A Multidisciplinary Journal</em> 28 (4): 638–48. <a href="https://doi.org/10.1080/10705511.2020.1784738" class="external-link">https://doi.org/10.1080/10705511.2020.1784738</a>.
</div>
<div id="ref-tibble" class="csl-entry">
Müller, Kirill, and Hadley Wickham. 2023. <em><span class="nocase">tibble</span>: Simple Data Frames</em>. <a href="https://CRAN.R-project.org/package=tibble" class="external-link">https://CRAN.R-project.org/package=tibble</a>.
</div>
<div id="ref-Neal2011" class="csl-entry">
Neal, Radford M. 2011. <span>“<span>MCMC</span> Using <span>Hamiltonian</span> Dynamics.”</span> In <em>Handbook of Markov Chain Monte Carlo</em>, edited by Steve Brooks, Andrew Gelman, Galin Jones, and Xiao-Li Meng. Chapman; Hall/CRC. <a href="https://doi.org/10.1201/b10905" class="external-link">https://doi.org/10.1201/b10905</a>.
</div>
<div id="ref-dynr" class="csl-entry">
Ou, Lu, Michael D. Hunter, and Sy-Miin Chow. 2019. <span>“What’s for <span class="nocase">dynr</span>: A Package for Linear and Nonlinear Dynamic Modeling in <span>R</span>.”</span> <em>The <span>R</span> Journal</em> 11 (1): 91–111. <a href="https://doi.org/10.32614/RJ-2019-012" class="external-link">https://doi.org/10.32614/RJ-2019-012</a>.
</div>
<div id="ref-Papaspiliopoulos2007" class="csl-entry">
Papaspiliopoulos, Omiros, Gareth O. Roberts, and Martin Sköld. 2007. <span>“A General Framework for the Parametrization of Hierarchical Models.”</span> <em>Statistical Science</em> 22 (1): 59–73. <a href="https://doi.org/10.1214/088342307000000014" class="external-link">https://doi.org/10.1214/088342307000000014</a>.
</div>
<div id="ref-Papastamoulis2016" class="csl-entry">
Papastamoulis, Panagiotis. 2016. <span>“<span class="nocase">label.switching</span>: An <span>R</span> Package for Dealing with the Label Switching Problem in <span>MCMC</span> Outputs.”</span> <em>Journal of Statistical Software, Code Snippets</em> 69 (1): 1–24. <a href="https://doi.org/10.18637/jss.v069.c01" class="external-link">https://doi.org/10.18637/jss.v069.c01</a>.
</div>
<div id="ref-Pearl1995" class="csl-entry">
Pearl, Judea. 1995. <span>“Causal Diagrams for Empirical Research.”</span> <em>Biometrika</em> 82 (4): 669–88. <a href="https://doi.org/10.1093/biomet/82.4.669" class="external-link">https://doi.org/10.1093/biomet/82.4.669</a>.
</div>
<div id="ref-Pearl2009" class="csl-entry">
———. 2009. <em>Causality: Models, Reasoning, and Inference</em>. 2nd ed. Cambridge University Press.
</div>
<div id="ref-R" class="csl-entry">
R Core Team. 2023. <em><span>R</span>: A Language and Environment for Statistical Computing</em>. Vienna, Austria: <span>R</span> Foundation for Statistical Computing. <a href="https://www.R-project.org/" class="external-link">https://www.R-project.org/</a>.
</div>
<div id="ref-lavaan" class="csl-entry">
Rosseel, Yves. 2012. <span>“<span class="nocase">lavaan</span>: An <span>R</span> Package for Structural Equation Modeling.”</span> <em>Journal of Statistical Software</em> 48 (2): 1–36. <a href="https://doi.org/10.18637/jss.v048.i02" class="external-link">https://doi.org/10.18637/jss.v048.i02</a>.
</div>
<div id="ref-Sallas1981" class="csl-entry">
Sallas, William M., and David A. Harville. 1981. <span>“Best Linear Recursive Estimation for Mixed Linear Models.”</span> <em>Journal of the American Statistical Association</em> 76 (376): 860–69. <a href="https://doi.org/10.1080/01621459.1981.10477734" class="external-link">https://doi.org/10.1080/01621459.1981.10477734</a>.
</div>
<div id="ref-rstan" class="csl-entry">
Stan Development Team. 2024a. <em><span>RStan</span>: The <span>R</span> Interface to <span>Stan</span></em>. <a href="https://mc-stan.org/" class="external-link">https://mc-stan.org/</a>.
</div>
<div id="ref-Stan" class="csl-entry">
———. 2024b. <em><span>Stan</span> Modeling Language Users Guide and Reference Manual</em>. <a href="https://mc-stan.org/" class="external-link">https://mc-stan.org/</a>.
</div>
<div id="ref-Sun2009" class="csl-entry">
Sun, Yiguo, Raymond J Carroll, and Dingding Li. 2009. <span>“Semiparametric Estimation of Fixed-Effects Panel Data Varying Coefficient Models.”</span> In <em>Nonparametric Econometric Methods</em>, 101–29. Advances in Econometrics. Emerald Group Publishing Limited. <a href="https://doi.org/10.1108/S0731-9053(2009)0000025006" class="external-link">https://doi.org/10.1108/S0731-9053(2009)0000025006</a>.
</div>
<div id="ref-tikz" class="csl-entry">
Tantau, Till. 2024. <em>The <span>TikZ</span> and <span>PGF</span> Packages: Manual for Version 3.1.10</em>. <a href="https://github.com/pgf-tikz/pgf" class="external-link">https://github.com/pgf-tikz/pgf</a>.
</div>
<div id="ref-dynamite" class="csl-entry">
Tikka, Santtu, and Jouni Helske. 2024a. <span>“<span class="nocase">dynamite</span>: An <span>R</span> Package for Dynamic Multivariate Panel Models.”</span> <a href="https://arxiv.org/abs/2302.01607" class="external-link">https://arxiv.org/abs/2302.01607</a>.
</div>
<div id="ref-dynamitepackage" class="csl-entry">
———. 2024b. <em><span class="nocase">dynamite</span>: <span>B</span>ayesian Modeling and Causal Inference for Multivariate Longitudinal Data</em>. <a href="https://github.com/ropensci/dynamite" class="external-link">https://github.com/ropensci/dynamite</a>.
</div>
<div id="ref-vanBuuren2018" class="csl-entry">
van Buuren, Stef. 2018. <em>Flexible Imputation of Missing Data</em>. 2nd ed. Chapman; Hall/CRC. <a href="https://doi.org/10.1201/9780429492259" class="external-link">https://doi.org/10.1201/9780429492259</a>.
</div>
<div id="ref-vanBuuren2011" class="csl-entry">
van Buuren, Stef, and Karin Groothuis-Oudshoorn. 2011. <span>“<span class="nocase">mice</span>: Multivariate Imputation by Chained Equations in <span>R</span>.”</span> <em>Journal of Statistical Software</em> 45 (3): 1–67. <a href="https://doi.org/10.18637/jss.v045.i03" class="external-link">https://doi.org/10.18637/jss.v045.i03</a>.
</div>
<div id="ref-loo" class="csl-entry">
Vehtari, Aki, Jonah Gabry, Mans Magnusson, Yuling Yao, Paul-Christian Bürkner, Topi Paananen, and Andrew Gelman. 2022. <em><span class="nocase">loo</span>: Efficient Leave-One-Out Cross-Validation and <span>WAIC</span> for <span>B</span>ayesian Models</em>. <a href="https://mc-stan.org/loo/" class="external-link">https://mc-stan.org/loo/</a>.
</div>
<div id="ref-vehtari2021rhat" class="csl-entry">
Vehtari, Aki, Andrew Gelman, Daniel Simpson, Bob Carpenter, and Paul-Christian Bürkner. 2021. <span>“Rank-Normalization, Folding, and Localization: An Improved <span class="math inline">\(\widehat{R}\)</span> for Assessing Convergence of <span>MCMC</span> (with Discussion).”</span> <em>Bayesian Analysis</em> 16 (2): 667–718. https://doi.org/<a href="https://doi.org/10.1214/20-BA1221" class="external-link">https://doi.org/10.1214/20-BA1221</a>.
</div>
<div id="ref-ggplot2" class="csl-entry">
Wickham, Hadley. 2016. <em><span class="nocase">ggplot2</span>: Elegant Graphics for Data Analysis</em>. Springer-Verlag. <a href="https://ggplot2.tidyverse.org" class="external-link">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-pryr" class="csl-entry">
———. 2023. <em><span class="nocase">pryr</span>: Tools for Computing on the Language</em>. <a href="https://CRAN.R-project.org/package=pryr" class="external-link">https://CRAN.R-project.org/package=pryr</a>.
</div>
<div id="ref-dplyr" class="csl-entry">
Wickham, Hadley, Romain François, Lionel Henry, Kirill Müller, and Davis Vaughan. 2023. <em><span class="nocase">dplyr</span>: A Grammar of Data Manipulation</em>. <a href="https://CRAN.R-project.org/package=dplyr" class="external-link">https://CRAN.R-project.org/package=dplyr</a>.
</div>
<div id="ref-Wood2020" class="csl-entry">
Wood, Simon N. 2020. <span>“Inference and Computation with Generalized Additive Models and Their Extensions.”</span> <em>TEST</em> 29 (2): 307–39. <a href="https://doi.org/10.1007/s11749-020-00711-5" class="external-link">https://doi.org/10.1007/s11749-020-00711-5</a>.
</div>
<div id="ref-Wooldridge2010" class="csl-entry">
Wooldridge, Jeffrey M. 2010. <em>Econometric Analysis of Cross Section and Panel Data</em>. MIT Press.
</div>
<div id="ref-Zyphur2020" class="csl-entry">
Zyphur, Michael J., Paul D. Allison, Louis Tay, Manuel C. Voelkle, Kristopher J. Preacher, Zhen Zhang, Ellen L. Hamaker, et al. 2020. <span>“From Data to Causes <span>I</span>: Building a General Cross-Lagged Panel Model (<span>GCLM</span>).”</span> <em>Organizational Research Methods</em> 23 (4): 651–87. <a href="https://doi.org/10.1177/1094428119847278" class="external-link">https://doi.org/10.1177/1094428119847278</a>.
</div>
</div>
</div>
<div class="section level2">
<h2 id="appendix-appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix-appendix"></a>
</h2>
</div>
<div class="section level2" number="8">
<h2 id="app:latentfactor">
<span class="header-section-number">A</span> Details on latent factors<a class="anchor" aria-label="anchor" href="#app:latentfactor"></a>
</h2>
<p>Latent factor models with product terms <span class="math inline">\(\lambda_i\psi_t\)</span> are known to suffer from identifiability issues. For example, it is possible to multiply each <span class="math inline">\(\lambda_i\)</span> by some constant <span class="math inline">\(c\)</span> while simultaneously multiplying <span class="math inline">\(\psi_i, t=1,\ldots, T\)</span> with the reciprocal of the same constant, leading to the same likelihood value as the original model. In case of multiple latent factors and (vector) autoregressive process on <span class="math inline">\(\psi_t\)</span>, discuss two alternative identifiability constraints, which in our single factor model translate to fixing <span class="math inline">\(\lambda_i = 1\)</span> for some <span class="math inline">\(i\)</span>, or constraining <span class="math inline">\(\lambda_i &gt; 0\)</span> for some <span class="math inline">\(i\)</span>, with an additional constraint that the standard deviation of the noise term of <span class="math inline">\(\psi_t\)</span> is 1. In both cases, we need to decide which individual is used as a reference for the constrained <span class="math inline">\(\lambda_i\)</span>. This choice can lead to computational issues if the true value of <span class="math inline">\(\lambda_i\)</span> is not compatible with these constrains (e.g., the true value is zero). Instead, we define the constraints via the mean of <span class="math inline">\(\lambda\)</span>.</p>
<p>Denote the expected value of the factor loadings as <span class="math inline">\(\bar \lambda\)</span>. Now write <span class="math inline">\(\lambda_i = \bar \lambda + \sigma^\ast_\lambda \lambda^\ast_i\)</span> where <span class="math inline">\(\lambda^\ast_i \sim N(0, 1)\)</span>. While <strong>dynamite</strong> models <span class="math inline">\(\psi_t\)</span> as spline, for the ease of exposition here we assume <span class="math inline">\(\psi_t\)</span> is a simple random walk <span class="math inline">\(\psi_t = \psi_{t-1} + \sigma_\psi\xi_t\)</span>.</p>
<p>Assume first that <span class="math inline">\(\bar \lambda \neq 0\)</span>. In this case, we can write
<span class="math display">\[
  (\bar\lambda + \sigma^\ast_\lambda \lambda^\ast_i)\psi_t, \quad \psi_t = \psi_{t-1} + \sigma_\psi\xi_t
\]</span>
as
<span class="math display">\[
  \lambda_i\psi_t, \quad \psi_t = \psi_{t-1} + \tau_\psi\xi_t,
\]</span>
where <span class="math inline">\(\lambda_i = 1 + \sigma_\lambda\lambda_i^\ast\)</span>, <span class="math inline">\(\sigma_\lambda= \sigma^\ast_\lambda / \bar\lambda\)</span>, and <span class="math inline">\(\tau_\psi = \bar\lambda\sigma_\psi\)</span>. Sampling <span class="math inline">\(\sigma_\lambda\)</span> and <span class="math inline">\(\tau_\psi\)</span> can be inefficient due to the strong negative correlation between these parameters, so instead we sample (and set priors for) <span class="math inline">\(\zeta = \sigma_\lambda + \tau_\psi\)</span> and <span class="math inline">\(0 &lt; \kappa &lt; 1\)</span> so that <span class="math inline">\(\sigma_\lambda = \kappa \zeta\)</span> and <span class="math inline">\(\tau_\psi = (1 - \kappa) \zeta\)</span>.</p>
<p>If instead <span class="math inline">\(\bar\lambda = 0\)</span>, then <span class="math inline">\(\lambda_i\psi_t = \sigma^\ast_\lambda \lambda^\ast_i\psi_t\)</span> is not uniquely identifiable, so we fix <span class="math inline">\(\tau_\psi=1\)</span> and sample <span class="math inline">\(\sigma_\lambda\)</span> directly. However, it is still possible to encounter multimodality due to sign-switching, which does not affect the predictions obtained from the model, but the automatic diagnostics of MCMC samples can be misleading. By default, <strong>dynamite</strong> tries to fix this by adjusting the signs of the <span class="math inline">\(\lambda\)</span> and <span class="math inline">\(\psi\)</span> terms based on the mean of the spline coefficients corresponding to <span class="math inline">\(\psi\)</span>. However, this only works if the mean of the spline coefficients is not close to zero, and it is possible to turn this option off so that the user can try to fix the sign-switching in the post-processing steps, e.g., by using the algorithms of the <strong>label.switching</strong> package <span class="citation">(<a href="#ref-Papastamoulis2016">Papastamoulis 2016</a>)</span>.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><!-- begin footer --><div class="footer">
    <div class="container">
        <div class="row start top-4 bottom-8">
            <div class="col-2"> <img id="footerlogo" src="https://ropensci.org/img/icon_short_white.svg">
</div>
            <div class="col-10">
                <div class="row">
                    <div class="col-md-4 col-xs-6">
                        <a href="https://github.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-github"></div></a>
                        <a href="https://github.com/ropenscilabs" target="_blank" class="external-link"><div class="icon fa fa-flask"></div></a>
                        <a href="https://hachyderm.io/@ropensci" target="_blank" class="external-link"><div class="icon fab fa-mastodon"></div></a>
                        <a href="https://vimeo.com/ropensci" target="_blank" class="external-link"><div class="icon fab fa-vimeo"></div></a>
                    </div>
                </div>
                <div class="row top-4">
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">About</h5>
                            <li><a href="https://ropensci.org/about" class="external-link">About rOpenSci</a></li>
                            <li><a href="https://ropensci.org/software-review" class="external-link">Software Review</a></li>
                            <li><a href="https://ropensci.org/about#team" class="external-link">Our Team</a></li>
                            <li><a href="https://ropensci.org/careers" class="external-link">Jobs</a></li>
                            <li><a href="https://ropensci.org/donate" class="external-link">Donate</a></li>
                            <li><a href="https://ropensci.org/contact" class="external-link">Contact Us</a></li>
                        </ul>
</div>
                    <div class="col-md-3 col-sm-4">
                        <ul>
<h5 class="bottom-2">Community</h5>
                            <li><a href="https://ropensci.org/community/" class="external-link">Our Community</a></li>
                            <li><a href="https://ropensci.org/commcalls/" class="external-link">Community calls</a></li>
                            <li><a href="https://ropensci.org/events/" class="external-link">Events</a></li>
                            <li><a href="https://discuss.ropensci.org/" class="external-link">Join the Discussion</a></li>
                            <li><a href="https://ropensci.org/code-of-conduct" class="external-link">Code of conduct</a></li>
                        </ul>
</div>
                    <div class="col-md-2 col-sm-4">
                        <ul>
<h5 class="bottom-2">Resources</h5>
                            <li><a href="https://ropensci.org/packages/" class="external-link">Packages</a></li>
                            <li><a href="https://ropensci.org/usecases/" class="external-link">Use Cases</a></li>
                            <li><a href="https://ropensci.org/talks-papers/" class="external-link">Talks &amp; Publications</a></li>
                            <li><a href="https://docs.ropensci.org/" class="external-link">Documentation</a></li>
                            <li><a href="https://ropensci.org/news/" class="external-link">Newsletter</a></li>
                            <li><a href="https://ropensci.org/how-to-cite-ropensci/" class="external-link">Cite rOpenSci</a></li>
                        </ul>
</div>
                    <div class="col-md-4 col-xs-12">
                        <h5 class="bottom-2"></h5>

                        <p>rOpenSci is a fiscally sponsored project of <a href="http://numfocus.org" class="external-link">NumFOCUS</a>.</p>

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- / end footer -->


    </footer>
</div>





  </body>
</html>
